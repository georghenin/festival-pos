<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Epson ePOS-Print Tester — Minimal (A6) Mode</title>
<style>
  :root{--bg:#0d0f13;--fg:#f5f7fa;--muted:#9aa6b2;--card:#0f141e;--border:#1b2230;--accent:#5b9bff;--ok:#2fd28f;--warn:#ffb020;--danger:#ff6b6b}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,textarea,select{font:inherit;background:#121826;color:#eaf0f6;border:1px solid var(--border);border-radius:10px;padding:10px 12px}
  textarea{width:100%;min-height:160px}
  .btn{border:none;border-radius:10px;padding:10px 12px;background:var(--accent);color:#fff;cursor:pointer}
  .btn.ok{background:var(--ok);color:#0b0e14}
  .btn.gray{background:#1e2432}
  .small{color:var(--muted);font-size:12px}
  .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:6px 10px;color:#aab3c0;background:#0f1420}
  pre{white-space:pre-wrap;word-break:break-word;background:#0b101a;border:1px solid var(--border);border-radius:12px;padding:10px;color:#eaf0f6}
</style>
</head>
<body>
<div class="wrap">
  <h2>Epson ePOS-Print Tester — Minimal (A6) Mode</h2>
  <div class="card">
    <div class="row">
      <input id="ip" placeholder="Printer IP (e.g. 192.168.4.98)">
      <input id="devid" placeholder="Device ID (e.g. printer)">
      <label>Endpoint:
        <select id="endpoint">
          <option value="service">/cgi-bin/epos/service.cgi</option>
          <option value="print">/cgi-bin/epos/print</option>
        </select>
      </label>
      <label><input type="checkbox" id="soap" checked> SOAP</label>
      <button class="btn ok" id="save">Save</button>
      <button class="btn gray" id="openWeb">Open Web Config</button>
      <span id="status" class="pill">Not tested</span>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>Quick Tests</h3>
    <div class="row">
      <button class="btn" id="testHello">Test: Hello</button>
      <button class="btn" id="testLong">Test: Long Text</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>Custom Text</h3>
    <textarea id="body">*** TEST PRINT ***</textarea>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="printCustom">Print Custom</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>Last Request & Response</h3>
    <pre id="req">(none)</pre>
    <pre id="resp">(none)</pre>
  </div>
</div>

<script>
const $ = (s)=>document.querySelector(s);
const ip=$('#ip'), devid=$('#devid'), endpoint=$('#endpoint'), soap=$('#soap');
const save=$('#save'), status=$('#status'), openWeb=$('#openWeb');
const req=$('#req'), resp=$('#resp');
const body=$('#body'), testHello=$('#testHello'), testLong=$('#testLong'), printCustom=$('#printCustom');

(function(){
  ip.value = localStorage.getItem('epson_ip') || '';
  devid.value = localStorage.getItem('epson_devid') || 'printer';
})();
save.onclick = ()=>{ localStorage.setItem('epson_ip', ip.value.trim()); localStorage.setItem('epson_devid', devid.value.trim()); status.textContent = 'Saved'; };

openWeb.onclick = ()=>{ const host=(ip.value||'').trim(); if(!host){alert('Enter IP first');return;} window.open('http://'+host+'/', '_blank'); };

function escXml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function envelope(inner){ return `<?xml version="1.0" encoding="utf-8"?>\n<epos-print xmlns="http://www.epson-pos.com/schemas/2011/03/epos-print">\n${inner}\n</epos-print>`; }
function wrapIfSoap(xml){ if(!soap.checked) return xml; return `<?xml version="1.0" encoding="utf-8"?>\n<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body>${xml}</s:Body></s:Envelope>`; }
function urlFor(host, devid){ const path = endpoint.value==='service'?'/cgi-bin/epos/service.cgi':'/cgi-bin/epos/print'; return `http://${host}${path}?devid=${encodeURIComponent(devid)}&timeout=60000`; }

function buildBody(text){ return `  <text>${escXml(text)}</text>\n`; }

async function send(innerContent){
  const host=(ip.value||'').trim(), dev=(devid.value||'printer').trim();
  if(!host){ alert('Set IP first.'); return; }
  const xml = envelope(innerContent);
  const payload = wrapIfSoap(xml);
  const url = urlFor(host, dev);
  req.textContent = payload;
  status.textContent = 'Sending…'; status.style.background='var(--warn)'; 
  try{
    const r = await fetch(url,{method:'POST',headers:{'Content-Type':'text/xml; charset=utf-8'},body:payload});
    const t = await r.text();
    resp.textContent = t; status.textContent = 'Done'; status.style.background='var(--ok)';
  }catch(e){ resp.textContent='Error: '+e.message; status.textContent='Error'; status.style.background='var(--danger)'; }
}

testHello.onclick = ()=> send(buildBody(`HELLO\n${new Date().toLocaleString()}`));
testLong.onclick  = ()=> send(buildBody(Array.from({length:20},(_,i)=>'Line '+(i+1)).join('\\n')));
printCustom.onclick = ()=> send(buildBody(body.value));
</script>
</body>
</html>
