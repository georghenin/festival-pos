<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Epson ePOS-Print Tester</title>
<style>
  :root{--bg:#0d0f13;--fg:#f5f7fa;--muted:#9aa6b2;--card:#0f141e;--border:#1b2230;--accent:#5b9bff;--ok:#2fd28f;--warn:#ffb020;--danger:#ff6b6b}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:900px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,textarea,select{font:inherit;background:#121826;color:#eaf0f6;border:1px solid var(--border);border-radius:10px;padding:10px 12px}
  textarea{width:100%;min-height:160px}
  .btn{border:none;border-radius:10px;padding:10px 12px;background:var(--accent);color:#fff;cursor:pointer}
  .btn.ok{background:var(--ok);color:#0b0e14}
  .btn.gray{background:#1e2432}
  .btn.warn{background:var(--warn);color:#0b0e14}
  .btn.danger{background:var(--danger);color:#0b0e14}
  .small{color:var(--muted);font-size:12px}
  .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:6px 10px;color:#aab3c0;background:#0f1420}
  pre{white-space:pre-wrap;word-break:break-word;background:#0b101a;border:1px solid var(--border);border-radius:12px;padding:10px;color:#eaf0f6}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:820px){ .grid2{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <h2 style="margin:0 0 6px 0">Epson ePOS-Print Tester</h2>
  <div class="small" style="margin-bottom:10px">
    Use this page to test your Epson receipt printer independently of your POS.
    In the printer’s Web Config, enable <b>ePOS-Print</b> and set a <b>Device ID</b> (default is <code>local_printer</code>).
    In Chrome, you may need to allow mixed content (HTTP) for this page.
  </div>

  <div class="card">
    <div class="row">
      <input id="ip" placeholder="Printer IP (e.g. 192.168.4.98)" style="min-width:220px">
      <input id="devid" placeholder="Device ID (e.g. local_printer)" style="min-width:220px">
      <button class="btn ok" id="save">Save</button>
      <button class="btn gray" id="openWeb">Open Web Config</button>
      <span id="status" class="pill">Not tested</span>
    </div>
  </div>

  <div class="grid2" style="margin-top:12px">
    <div class="card">
      <h3 style="margin:0 0 8px 0">Quick Tests</h3>
      <div class="row">
        <button class="btn" id="testHello">Test: Hello</button>
        <button class="btn" id="testCut">Test: Cut</button>
        <button class="btn" id="testLong">Test: Long Text</button>
      </div>
      <div class="small" style="margin-top:8px">
        These send simple XML over HTTP to the printer using Epson’s ePOS-Print schema.
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">Custom Text</h3>
      <div class="row">
        <label>Font:
          <select id="font">
            <option value="font_a">Font A (standard)</option>
            <option value="font_b">Font B (small)</option>
          </select>
        </label>
        <label>Width × Height:
          <select id="w"><option>1</option><option>2</option><option>3</option></select>
          ×
          <select id="h"><option>1</option><option>2</option><option>3</option></select>
        </label>
      </div>
      <textarea id="body">*** TEST PRINT ***\nHello from the ePOS-Print tester!\n— Timestamp —</textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="printCustom">Print Custom Text</button>
        <button class="btn warn" id="drawer">Open Cash Drawer (pin 2)</button>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3 style="margin:0 0 8px 0">Last Request & Response</h3>
    <div class="small">XML sent:</div>
    <pre id="req">(none)</pre>
    <div class="small">Response:</div>
    <pre id="resp">(none)</pre>
  </div>
</div>

<script>
const $ = (s)=>document.querySelector(s);
const ip = $('#ip'), devid = $('#devid'), save = $('#save'), status = $('#status'), openWeb = $('#openWeb');
const req = $('#req'), resp = $('#resp');
const body = $('#body'), font = $('#font'), w = $('#w'), h = $('#h');
const testHello = $('#testHello'), testCut = $('#testCut'), testLong = $('#testLong'), printCustom = $('#printCustom'), drawer = $('#drawer');

// Load prefs
(function(){
  ip.value = localStorage.getItem('epson_ip') || '';
  devid.value = localStorage.getItem('epson_devid') || 'local_printer';
  body.value = (localStorage.getItem('epson_body') || body.value);
  font.value = localStorage.getItem('epson_font') || 'font_a';
  w.value = localStorage.getItem('epson_w') || '1';
  h.value = localStorage.getItem('epson_h') || '1';
})();

save.onclick = ()=>{
  localStorage.setItem('epson_ip', (ip.value||'').trim());
  localStorage.setItem('epson_devid', (devid.value||'local_printer').trim());
  localStorage.setItem('epson_body', body.value);
  localStorage.setItem('epson_font', font.value);
  localStorage.setItem('epson_w', w.value);
  localStorage.setItem('epson_h', h.value);
  status.textContent = 'Saved';
  status.style.background = 'var(--ok)';
  status.style.color = '#0b0e14';
};

openWeb.onclick = ()=>{ const host=(ip.value||'').trim(); if(!host){alert('Enter printer IP first.');return;} window.open('http://'+host+'/', '_blank'); };

function escXml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function buildEnvelope(inner){ return `<?xml version="1.0" encoding="utf-8"?>\n<epos-print xmlns="http://www.epson-pos.com/schemas/2011/03/epos-print">\n${inner}\n</epos-print>`; }

async function sendXml(inner){
  const host=(ip.value||'').trim(); const dev=(devid.value||'local_printer').trim();
  if(!host){ alert('Set the printer IP first.'); return; }
  const url=`http://${host}/cgi-bin/epos/service.cgi?devid=${encodeURIComponent(dev)}&timeout=60000`;
  const xml=buildEnvelope(inner);
  req.textContent=xml; status.textContent='Sending...'; status.style.background='var(--warn)';
  try{
    const r=await fetch(url,{method:'POST',headers:{'Content-Type':'text/xml'},body:xml});
    const t=await r.text(); resp.textContent=t; status.textContent='Done'; status.style.background='var(--ok)';
  }catch(e){ resp.textContent='Fetch error: '+e.message; status.textContent='Error'; status.style.background='var(--danger)'; }
}

// Quick tests
testHello.onclick=()=>{ const ts=new Date().toLocaleString(); const inner=`<text font="font_a">*** HELLO ***\\n${escXml(ts)}\\n</text><feed line="2"/><cut type="feed"/>`; sendXml(inner); };
testCut.onclick=()=>{ sendXml(`<feed line="4"/><cut type="feed"/>`); };
testLong.onclick=()=>{ const lines=Array.from({length:20},(_,i)=>'Line '+(i+1)).join('\\n'); sendXml(`<text font="font_a">${escXml(lines)}</text><feed line="2"/><cut type="feed"/>`); };

// Custom text
printCustom.onclick=()=>{ const msg=(body.value||'')+'\\n'+new Date().toLocaleString(); const inner=`<text font="${font.value}" width="${w.value}" height="${h.value}">${escXml(msg)}</text><feed line="2"/><cut type="feed"/>`; sendXml(inner); };
// Drawer
drawer.onclick=()=> sendXml(`<pulse drawer="2" time="100"/><feed line="1"/>`);
</script>
</body>
</html>
