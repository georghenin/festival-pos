<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KDS (v2)</title>

  <style>
    :root{--bg:#0d0f13;--fg:#f5f7fa;--muted:#95a0ad;--accent:#5b9bff;--ok:#2fd28f;--warn:#ffb020;--danger:#ff6b6b;--card:#0f141e;--border:#1b2230}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .space{height:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    .btn{border:none;border-radius:12px;padding:12px 14px;color:#fff;background:var(--accent);font:inherit;cursor:pointer}
    .btn.ok{background:var(--ok)} .btn.warn{background:var(--warn)} .btn.danger{background:var(--danger)} .btn.gray{background:#1e2432;color:#e5e8ee}
    input,select{font:inherit;background:#121826;color:#eaf0f6;border:1px solid var(--border);border-radius:12px;padding:12px 14px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0f1420;color:#95a0ad;font-size:12px}
    .grid{display:grid;gap:12px}
    .title{margin:0;font-size:20px}
    .small{font-size:12px;color:#95a0ad}
    .hidden{display:none!important}
    table{width:100%;border-collapse:collapse}
    td,th{border-bottom:1px solid var(--border);padding:8px;text-align:left}
  </style>

<style>
  .top{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
  .board{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;padding:16px;overflow:auto;max-height:calc(100vh - 120px)}
  .ticket{background:#121826;border:1px solid var(--border);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:10px}
  .head{display:flex;justify-content:space-between;align-items:center}
  .cust{font-size:18px;font-weight:700}
  .items li{margin:4px 0}
</style>
</head>
<body>
<div class="container">
  <div class="top">
    <div class="row">
      <h2 class="title">Kitchen Display</h2>
      <span class="pill" id="stationPill"></span>
    </div>
    <div class="row">
      <span class="pill" id="count">0</span>
      <button class="btn gray" id="all">All</button>
      <button class="btn gray" data-s="Grill">Grill</button>
      <button class="btn gray" data-s="Fryer">Fryer</button>
      <button class="btn gray" data-s="Drinks">Drinks</button>
      <button class="btn gray" data-s="Pizza">Pizza</button>
    </div>
  </div>
  <div class="board" id="board"></div>
</div>


  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>

<script>

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBu-Ux4lvGn6-pnBngmJzL0BAtW1uIfOKM",
  authDomain: "churchfestivalpos.firebaseapp.com",
  projectId: "churchfestivalpos",
  storageBucket: "churchfestivalpos.firebasestorage.app",
  messagingSenderId: "447909610900",
  appId: "1:447909610900:web:a54a828bacfa02e7883b81"
};

const qs = new URLSearchParams(location.search);
let station = qs.get('station')||'';
function stationMatch(itemStation){ return !station || itemStation===station; }
function fmtAgo(ts){ if(!ts) return 'â€”'; const d=Date.now()-ts; const m=Math.floor(d/60000); return m<1?'now':m+'m'; }

firebase.initializeApp(FIREBASE_CONFIG);
const db=firebase.firestore();
const board = document.getElementById('board'); const count=document.getElementById('count'); const stationPill=document.getElementById('stationPill');
stationPill.textContent = station? ('Station: '+station):'All stations';

function render(tickets){
  board.innerHTML = tickets.map(t=>`
    <div class="ticket">
      <div class="head">
        <div><b>#${t.number}</b> <span class="small">â€¢ ${fmtAgo(t.createdAt)}</span></div>
        <button class="btn ok" data-id="${t.id}">Ready</button>
      </div>
      ${t.customer?`<div class="cust">ðŸ‘¤ ${t.customer}</div>`:''}
      <ul class="items">${
        t.items.filter(i=>stationMatch(i.station)).map(i=>`<li>Ã—${i.qty} â€” ${i.name}</li>`).join('')}
      </ul>
    </div>
  `).join('');
  count.textContent = tickets.length;
  board.querySelectorAll('button[data-id]').forEach(b=> b.onclick = ()=> markReady(b.getAttribute('data-id')));
}

async function markReady(id){
  await db.collection('orders').doc(id).update({status:'ready', readyAt:Date.now(), updatedAt:Date.now()});
}

let unsub;
function sub(){
  if(unsub) unsub();
  let q = db.collection('orders').where('status','in',['new','in_progress']).orderBy('createdAt','asc').limit(200);
  unsub = q.onSnapshot(snap=>{
    const list=[]; snap.forEach(d=> {
      const o={id:d.id, ...d.data()};
      if(station) o.items = o.items.filter(i=>i.station===station);
      if(o.items && o.items.length>0) list.push(o);
    });
    render(list);
  });
}
sub();

document.getElementById('all').onclick=()=>{ station=''; stationPill.textContent='All stations'; sub(); };
document.querySelectorAll('button[data-s]').forEach(b=> b.onclick=()=>{ station=b.dataset.s; stationPill.textContent='Station: '+station; sub(); });
</script>
</body></html>
