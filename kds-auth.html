<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KDS (Sign-In + Station Filters + Sound)</title>
<style>
  :root{--bg:#0d0f13;--fg:#f5f7fa;--muted:#95a0ad;--border:#1b2230;--ok:#2fd28f;--danger:#ff6b6b}
  html,body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0}
  .top{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
  .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:#aab3c0}
  .board{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;padding:16px;max-height:calc(100vh - 140px);overflow:auto}
  .ticket{background:#121826;border:1px solid var(--border);border-radius:16px;padding:12px}
  .small{font-size:12px;color:#aab3c0}
  .btn{border:none;border-radius:10px;padding:8px 12px;background:#1e2432;color:#e5e8ee;cursor:pointer}
  .btn.primary{background:var(--ok);color:#0b0e14}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .auth{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap}
  input{font:inherit;background:#121826;color:#eaf0f6;border:1px solid var(--border);border-radius:10px;padding:10px 12px}
</style>
</head>
<body>

<div class="auth" id="auth">
  <input id="email" type="email" placeholder="KDS email (or cashier/admin)" style="min-width:220px">
  <input id="pass" type="password" placeholder="Password" style="min-width:160px">
  <button id="login" class="btn primary">Sign in</button>
  <span id="authMsg" class="small"></span>
</div>

<div class="top">
  <div class="row">
    <b>Kitchen Display</b>
    <span class="pill" id="stationPill">All stations</span>
  </div>
  <div class="row">
    <span class="pill" id="me">Signed out</span>
    <span class="pill" id="count">0</span>
    <button id="stationBtn" class="btn">Stationsâ€¦</button>
    <label class="pill" style="cursor:pointer">
      <input type="checkbox" id="soundToggle" style="margin-right:6px"> Sound
    </label>
  </div>
</div>

<div class="board" id="board"></div>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script>
// ---- Firebase (your project) ----
firebase.initializeApp({
  apiKey: "AIzaSyBu-Ux4lvGn6-pnBngmJzL0BAtW1uIfOKM",
  authDomain: "churchfestivalpos.firebaseapp.com",
  projectId: "churchfestivalpos",
  storageBucket: "churchfestivalpos.firebasestorage.app",
  messagingSenderId: "447909610900",
  appId: "1:447909610900:web:a54a828bacfa02e7883b81"
});
const db=firebase.firestore(), auth=firebase.auth();

// ---- UI refs ----
const board=document.getElementById('board');
const count=document.getElementById('count');
const me=document.getElementById('me');
const authBox=document.getElementById('auth');
const email=document.getElementById('email');
const pass=document.getElementById('pass');
const login=document.getElementById('login');
const authMsg=document.getElementById('authMsg');
const stationPill=document.getElementById('stationPill');
const stationBtn=document.getElementById('stationBtn');
const soundToggle=document.getElementById('soundToggle');

const ALL_STATIONS = ['Grill','Fryer','Drinks','Pizza'];

// ---- Stations selection (URL + localStorage) ----
const qs=new URLSearchParams(location.search);
const urlParam = (qs.get('station')||'').trim();
let ALLOW = new Set(); // allowed stations; empty = show all
try{
  const saved = JSON.parse(localStorage.getItem('kdsStations')||'[]');
  if(saved && saved.length) ALLOW = new Set(saved);
  else if(urlParam){ ALLOW = new Set(urlParam.split(',').map(s=>s.trim()).filter(Boolean)); }
}catch(e){}
function refreshPill(){
  stationPill.textContent = ALLOW.size ? ('Stations: ' + [...ALLOW].join(', ')) : 'All stations';
}
refreshPill();

function openStations(){
  const box = document.createElement('div');
  box.innerHTML = `
  <div style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:50">
    <div style="background:#0f141e;border:1px solid #1b2230;border-radius:12px;padding:14px;min-width:280px">
      <h3 style="margin:0 0 8px 0">Show stations</h3>
      ${ALL_STATIONS.map(s=>`
        <label style="display:block;margin:6px 0">
          <input type="checkbox" value="${s}" ${ALLOW.has(s)?'checked':''}> ${s}
        </label>
      `).join('')}
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="stCancel" class="btn">Cancel</button>
        <button id="stSave" class="btn primary">Save</button>
      </div>
    </div>
  </div>`;
  document.body.appendChild(box);
  box.querySelector('#stCancel').onclick = ()=> box.remove();
  box.querySelector('#stSave').onclick = ()=>{
    const sel = [...box.querySelectorAll('input[type=checkbox]:checked')].map(i=>i.value);
    ALLOW = new Set(sel);
    localStorage.setItem('kdsStations', JSON.stringify(sel));
    refreshPill();
    box.remove();
  };
}
stationBtn.addEventListener('click', openStations);

// ---- Sound ----
let SOUND_ON=false, lastSeenCreatedAt=0, firstSnap=true;
soundToggle.onchange = ()=>{ SOUND_ON = soundToggle.checked; if(SOUND_ON) ding(true); };
function ding(test=false){
  if(!SOUND_ON && !test) return;
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='sine';o.frequency.value=880;o.connect(g);g.connect(ctx.destination);
    g.gain.value=0.0001; g.gain.exponentialRampToValueAtTime(0.25, ctx.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.35);
    o.start(); o.stop(ctx.currentTime+0.4);
  }catch(e){}
}
function stationAllowed(s){
  if(!ALLOW.size) return true;
  return ALLOW.has(s||'');
}
function fmtAgo(ts){ if(!ts) return 'â€”'; const m=Math.floor((Date.now()-ts)/60000); return m<1?'now':m+'m'; }

// ---- Auth ----
auth.onAuthStateChanged(u=>{
  if(u){ me.textContent = u.email; authBox.style.display='none'; }
  else { me.textContent = 'Signed out'; authBox.style.display='flex'; }
});
login.onclick = async ()=>{
  authMsg.textContent='Signing in...';
  try{
    await auth.signInWithEmailAndPassword(email.value.trim(), pass.value);
    authMsg.textContent='Signed in';
  }catch(e){ authMsg.textContent=e.message; }
};

// ---- Data stream (single orderBy; filter client-side) ----
let unsub = db.collection('orders').orderBy('createdAt','asc').limit(200).onSnapshot(snap=>{
  const list=[];
  let newest = lastSeenCreatedAt;
  snap.forEach(d=>{
    const o={id:d.id, ...d.data()};
    if(o.status==='new' || o.status==='in_progress'){
      const its = (o.items||[]).filter(i=> stationAllowed(i.station));
      if(its.length>0) list.push({...o, items:its});
    }
    if(o.createdAt) newest = Math.max(newest, o.createdAt);
  });
  const hasNew = !firstSnap && newest>lastSeenCreatedAt;
  lastSeenCreatedAt = newest;
  firstSnap=false;
  render(list);
  if(hasNew) ding();
}, err=>{
  board.innerHTML = `<div class="small">Error: ${err.message}</div>`;
});

function render(tickets){
  board.innerHTML = tickets.map(t=>`
    <div class="ticket">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><b>#${t.number}</b> <span class="small">â€¢ ${fmtAgo(t.createdAt)}</span></div>
        <button class="btn primary" data-id="${t.id}">Ready</button>
      </div>
      ${t.customer?`<div style="margin-top:6px"><b>ðŸ‘¤ ${t.customer}</b></div>`:''}
      <ul style="margin:8px 0 0 16px">
        ${t.items.map(i=>`<li>Ã—${i.qty} â€” ${i.name} ${i.station?`<span class="small" style="color:#9fb0c3">(${i.station})</span>`:''}</li>`).join('')}
      </ul>
    </div>
  `).join('');
  count.textContent = tickets.length;
  board.querySelectorAll('button[data-id]').forEach(b=>{
    b.onclick = async ()=>{
      try{
        await db.collection('orders').doc(b.dataset.id)
          .update({status:'ready', readyAt:Date.now(), updatedAt:Date.now()});
      }catch(e){
        alert('Update failed: '+e.message);
      }
    };
  });
}
</script>
</body></html>
