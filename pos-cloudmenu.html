<!-- kds-auth.html (LIGHT THEME + larger fonts + archived/refunded filtering + undo-ready) -->
<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KDS</title>
<style>
  /* ---- Light, high-contrast theme variables ---- */
  :root{
    --bg:#ffffff;       /* page background */
    --fg:#111111;       /* primary text */
    --muted:#555555;    /* secondary text */
    --card:#f5f7fb;     /* panels/cards */
    --border:#d0d7e2;   /* borders & dividers */
    --ok:#15a46b;       /* success */
    --accent:#2563eb;   /* primary action */
  }

  *{box-sizing:border-box}
  html,body{
    margin:0;background:var(--bg);color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    font-size:18px; /* +2 for outdoor readability */
    line-height:1.25;
  }

  .wrap{max-width:1280px;margin:0 auto;padding:16px}

  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}

  .pill{
    border:1px solid var(--border);border-radius:999px;
    padding:8px 12px;color:var(--muted);background:#ffffff;
    font-weight:600;font-size:16px;
  }

  .btn{
    border:1px solid var(--border);border-radius:12px;
    padding:12px 14px;cursor:pointer;
    background:#ffffff;color:#111111;font-weight:700;font-size:18px;
  }
  .btn.gray{background:#f1f5f9}
  .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
  .btn.ok{background:var(--ok);color:#fff;border-color:transparent}

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:18px;
    padding:14px
  }

  .chips{display:flex;gap:10px;flex-wrap:wrap}
  .chip{
    border:1px solid var(--border);background:#ffffff;color:#111;
    border-radius:999px;padding:8px 12px;cursor:pointer;
    font-weight:700;font-size:16px;
  }
  .chip.active{outline:3px solid var(--ok)}

  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
    gap:14px
  }

  .ticket{
    border:1px solid var(--border);
    background:#ffffff;
    border-radius:16px;
    padding:12px
  }

  .hdr{display:flex;justify-content:space-between;gap:12px;align-items:center}
  .customer{font-weight:800;font-size:20px}
  .line{border-top:1px dashed var(--border);padding:8px 0}

  /* ==== Bigger, clearer modifiers (light look) ==== */
  .mods{margin-top:6px;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .mods .label{font-size:16px;color:#334155;font-weight:800;margin-right:4px}
  .mods .opt{
    font-size:16px;line-height:1.2;font-weight:800;color:#0f172a;
    padding:6px 10px;border-radius:999px;background:#eef2ff;border:1px solid #c7d2fe
  }

  .muted{color:var(--muted);font-size:16px}
  .tag{
    display:inline-block;border:1px solid var(--border);
    border-radius:999px;padding:2px 10px;font-size:14px;
    background:#f1f5f9;color:#111111;font-weight:700
  }

  input[type="checkbox"]{transform:scale(1.15);margin-right:8px}
</style>
</head>
<body>
<div class="wrap">

  <div class="row" style="justify-content:space-between">
    <div class="row">
      <strong style="font-size:22px">KDS</strong>
      <span id="stationBadge" class="pill">Stations: loading…</span>
    </div>
    <div class="row">
      <label class="pill"><input id="sound" type="checkbox"> Sound on new</label>
      <label class="pill"><input id="showDone" type="checkbox"> Show completed</label>
      <span id="me" class="pill">Not signed in</span>
      <button id="login" class="btn gray">Sign in</button>
      <button id="logout" class="btn gray">Sign out</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between">
      <div class="chips" id="chips"></div>
      <div class="row">
        <button id="selectAll" class="btn gray">Select all</button>
        <button id="savePref" class="btn primary">Save to this iPad</button>
      </div>
    </div>
    <div class="muted" style="margin-top:8px">Only items from the selected stations will appear here.</div>
  </div>

  <div class="grid" id="grid" style="margin-top:12px"></div>
  <div id="empty" class="muted" style="margin-top:8px;display:none">No tickets.</div>
</div>

<audio id="ding" preload="auto"></audio>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script>
/* Firebase init */
firebase.initializeApp({
  apiKey:"AIzaSyBu-Ux4lvGn6-pnBngmJzL0BAtW1uIfOKM",
  authDomain:"churchfestivalpos.firebaseapp.com",
  projectId:"churchfestivalpos"
});
const db=firebase.firestore(), auth=firebase.auth();

/* Shorthands & refs */
const $=s=>document.querySelector(s);
const me=$('#me'), login=$('#login'), logout=$('#logout');
const chips=$('#chips'), stationBadge=$('#stationBadge');
const showDone=$('#showDone'), grid=$('#grid'), empty=$('#empty'), selectAll=$('#selectAll'), savePref=$('#savePref');

/* Sound */
const SOUND_URL = "https://georghenin.github.io/festival-pos/mixkit-bell-notification-933.wav";
const dingEl = document.getElementById('ding');
dingEl.src = SOUND_URL;
const soundCb = document.getElementById('sound');
let lastSoundTs = Number(localStorage.getItem('kdsLastSoundTs')||'0');
function armAudioOnce(){ window.removeEventListener('click', armAudioOnce, true); try { dingEl.volume = 1.0; dingEl.play().then(()=>dingEl.pause()).catch(()=>{}); } catch(_) {} }
window.addEventListener('click', armAudioOnce, true);
function playDing(){ if(!soundCb.checked) return; try { dingEl.currentTime = 0; dingEl.volume = 1.0; dingEl.play().catch(()=>{}); } catch(_) {} }
function newestTsForKDS(orders){ let n=0; for(const o of orders){ const ts=Number(o.updatedAt||o.createdAt||0); if(ts>n) n=ts; } return n; }

/* Auth */
let STATIONS=['Grill','Fryer','Drinks','Pizza'];
let selected=new Set(JSON.parse(localStorage.getItem('kdsStations')||'[]'));
let lastSnapshot=null;

auth.onAuthStateChanged(u=>{ me.textContent=u?u.email:'Not signed in'; });
login.onclick=async()=>{ const e=prompt('Email:'); if(!e) return; const p=prompt('Password:'); if(p===null) return; try{await auth.signInWithEmailAndPassword(e.trim(),p);}catch(err){alert(err.message);} };
logout.onclick=()=>auth.signOut();

/* Stations */
async function loadStations(){
  try{
    const s=await db.collection('settings').doc('config').get();
    const conf=s.data(); if(conf && Array.isArray(conf.stations) && conf.stations.length) STATIONS=conf.stations;
  }catch(e){}
  renderChips(); stationBadge.textContent='Stations: '+STATIONS.join(', ');
}
function renderChips(){
  if(!selected.size){ STATIONS.forEach(s=>selected.add(s)); }
  chips.innerHTML = STATIONS.map(s=>`<span class="chip ${selected.has(s)?'active':''}" data-st="${s}">${s}</span>`).join('');
  chips.querySelectorAll('.chip').forEach(c=>{
    c.onclick=()=>{ const s=c.dataset.st; if(selected.has(s)) selected.delete(s); else selected.add(s); renderChips(); renderTickets(lastSnapshot); };
  });
}
selectAll.onclick=()=>{ selected=new Set(STATIONS); renderChips(); renderTickets(lastSnapshot); };
savePref.onclick=()=>{ localStorage.setItem('kdsStations', JSON.stringify([...selected])); alert('Saved on this iPad.'); };

/* Live feed */
db.collection('orders').orderBy('createdAt','desc').limit(150).onSnapshot(snap=>{
  lastSnapshot=snap; renderTickets(snap);
});
showDone.onchange=()=> renderTickets(lastSnapshot);

const itemMatchesStations = (it)=> !it.station || selected.has(it.station);

/* Modifiers -> larger pills in light theme */
function modsHTML(mods){
  if(!mods) return '';
  let parts=[];
  if (Array.isArray(mods) && mods.length && mods[0]?.options){
    mods.forEach(g=> (g.options||[]).forEach(o=>{ if (o?.name) parts.push(`<span class="opt">${o.name}</span>`); }));
  } else if (Array.isArray(mods)){
    mods.forEach(m=>{ if(m?.name) parts.push(`<span class="opt">${m.name}</span>`); });
  } else if (typeof mods === 'object' && mods.name){
    parts.push(`<span class="opt">${mods.name}</span>`);
  }
  if(!parts.length) return '';
  return `<div class="mods"><span class="label">Mods:</span> ${parts.join(' ')}</div>`;
}

/* Visibility helpers */
function isArchivedOrRefunded(o){ return o?.archived === true || o?.status === 'refunded'; }
function stationItems(o){ return (o.items||[]).filter(it=> itemMatchesStations(it)); }
function allStationItemsReady(o){ const arr = stationItems(o); return arr.length>0 && arr.every(it=> !!it.ready ); }

function renderTickets(snap){
  if(!snap){ grid.innerHTML=''; empty.style.display='block'; return; }
  const includeCompleted = !!showDone.checked;

  const html=[];
  const shownForSound=[];

  snap.forEach(d=>{
    const o={id:d.id, ...d.data()};
    if (isArchivedOrRefunded(o)) return;

    const pendingForStation = stationItems(o).filter(it=> !it.ready);
    const completedForStation = stationItems(o).filter(it=> !!it.ready);

    if (!includeCompleted){
      if (!pendingForStation.length) return; /* Active: needs pending */
    } else {
      if (!allStationItemsReady(o)) return;  /* Completed: all selected-station items ready */
    }

    shownForSound.push(o);

    const lines = (!includeCompleted ? pendingForStation : completedForStation)
      .map(it=>`
        <div class="line">
          <div><strong style="font-size:18px">${it.qty||1}× ${it.name||''}</strong> <span class="muted">• ${it.station||''}</span></div>
          ${modsHTML(it.mods)} ${it.ready?'<span class="tag">ready</span>':''}
        </div>`).join('');

    const actionBtn = !includeCompleted
      ? `<button class="btn ok" data-ready="${o.id}">Ready (this station)</button>`
      : `<button class="btn gray" data-undo="${o.id}">Undo Ready (this station)</button>`;

    html.push(`
      <div class="ticket">
        <div class="hdr">
          <div>
            <div class="customer">${o.customer||'No name'} <span class="muted">#${o.number||''}</span></div>
            <div class="muted" style="font-size:15px">${new Date(o.createdAt||Date.now()).toLocaleTimeString()}</div>
          </div>
          <div>${actionBtn}</div>
        </div>
        ${lines}
      </div>`);
  });

  grid.innerHTML = html.join('');
  empty.style.display = html.length? 'none':'block';

  const newest = newestTsForKDS(shownForSound);
  if(newest && newest > lastSoundTs){ playDing(); lastSoundTs=newest; localStorage.setItem('kdsLastSoundTs', String(lastSoundTs)); }

  grid.querySelectorAll('[data-ready]').forEach(b=>{ b.onclick=()=> setReadyForThisStation(b.dataset.ready); });
  grid.querySelectorAll('[data-undo]').forEach(b=>{ b.onclick=()=> undoReadyForThisStation(b.dataset.undo); });
}

/* Transitions (no SMS) */
async function setReadyForThisStation(orderId){
  const now=Date.now();
  const ref=db.collection('orders').doc(orderId);
  try{
    await db.runTransaction(async tx=>{
      const snap=await tx.get(ref); if(!snap.exists) return;
      const o=snap.data(); if (isArchivedOrRefunded(o)) return;

      const items=(o.items||[]).map(it=> (itemMatchesStations(it) && !it.ready) ? {...it, ready:true, readyAt: now} : it);
      const allReadySelected = stationItems({items, station:o.station}).every(it=>it.ready);
      const anyPendingOtherStations = (o.items||[]).some(it=> !itemMatchesStations(it) && !it.ready);

      const updates = { items, updatedAt: now, archived:false };
      updates.status = (allReadySelected && !anyPendingOtherStations) ? 'ready' : 'partial';
      if (updates.status==='ready' && !o.readyAt) updates.readyAt = now;

      tx.update(ref, updates);
    });
  }catch(e){ alert(e.message); }
}

async function undoReadyForThisStation(orderId){
  const ref=db.collection('orders').doc(orderId);
  try{
    await db.runTransaction(async tx=>{
      const snap=await tx.get(ref); if(!snap.exists) return;
      const o=snap.data(); if (isArchivedOrRefunded(o)) return;

      const items=(o.items||[]).map(it=>{
        if(itemMatchesStations(it) && it.ready){
          const {ready, readyAt, ...rest} = it;
          return {...rest, ready:false};
        }
        return it;
      });
      tx.update(ref, { items, updatedAt: Date.now(), status:'active' });
    });
  }catch(e){ alert(e.message); }
}

loadStations();
</script>
</body></html>
