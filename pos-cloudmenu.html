<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Festival POS</title>
<style>
  :root{--bg:#0d0f13;--fg:#f5f7fa;--muted:#95a0ad;--card:#0f141e;--border:#1b2230;--accent:#5b9bff;--ok:#2fd28f;--warn:#ffb020;--danger:#ff6b6b}
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .left-right{display:grid;grid-template-columns:1fr 380px;gap:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
  input,select,button{font:inherit}
  input,select{background:#121826;color:#eaf0f6;border:1px solid var(--border);border-radius:10px;padding:10px 12px}
  button{border:none;border-radius:10px;padding:10px 12px;cursor:pointer}
  .btn{background:var(--accent);color:#fff}.btn.ok{background:var(--ok);color:#0b0e14}.btn.gray{background:#1e2432}.btn.danger{background:#ff6b6b;color:#0b0e14}
  .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;color:#aab3c0}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
  .tab{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#0f1420;color:#e5e8ee;cursor:pointer}
  .tab.active{outline:2px solid var(--ok)}
  .menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
  .item{background:#121826;border:1px solid var(--border);border-radius:14px;padding:8px;cursor:pointer;display:flex;flex-direction:column;align-items:flex-start}
  .item img{width:100%;height:100px;object-fit:cover;border-radius:10px;margin-bottom:6px;background:#0b101a;border:1px solid var(--border)}
  .item .nm{font-weight:600}.item .pr{color:#cfe3ff;font-size:13px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left;vertical-align:top}
  .right .card{position:sticky;top:10px}
  .total{display:flex;justify-content:space-between;font-weight:700;margin-top:8px}
  .qbtn{padding:4px 8px;border-radius:8px;background:#1d2331;color:#dfe6f5}
  .modal-mask{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:50}
  .modal{background:#0f141e;border:1px solid var(--border);border-radius:14px;padding:14px;max-width:520px;width:92%}
  .opt{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px dashed #1b2230}
  .muted{color:var(--muted);font-size:13px}
  .hdr{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  .hdr-title{font-size:22px;font-weight:800}
  .hdr-right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
  .customer-wrap{margin-top:8px}
  #customer{width:100%;font-size:20px;padding:14px 16px;border-radius:12px}
  .small{font-size:12px;color:#9fb0c9}
  @media (max-width:900px){ .left-right{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="hdr">
    <div class="row">
      <span class="hdr-title">Festival POS <span class="pill" style="margin-left:6px">vPRINT‑3</span></span>
      <span id="stationsBadge" class="pill">Stations: loading…</span>
    </div>
    <div class="hdr-right">
      <span id="me" class="pill">Signed out</span>
      <button id="loginBtn" class="btn">Sign in</button>
      <button id="logoutBtn" class="btn gray" style="display:none">Sign out</button>
    </div>
  </div>

  <!-- Customer -->
  <div class="customer-wrap">
    <input id="customer" placeholder="Customer name (required)">
  </div>

  <div class="left-right" style="margin-top:10px">
    <!-- MENU SIDE -->
    <div>
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="tabs" id="stationTabs"><button class="tab active" data-st="__ALL__">All</button></div>
          <input id="search" placeholder="Search items…" style="min-width:220px">
        </div>
        <div id="menu" class="menu-grid"></div>
        <div id="menuEmpty" class="muted" style="display:none;margin-top:8px">No items.</div>
      </div>

      <!-- Receipt Printer -->
      <div class="card" id="printerCard" style="margin-top:10px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <strong>Receipt Printer</strong>
          <label class="row" style="gap:6px"><input type="checkbox" id="autoPrint"> Auto‑print on submit</label>
        </div>
        <div class="row" style="margin-top:8px;gap:8px">
          <input id="printerIp" placeholder="Printer IP (e.g. 192.168.4.98)" style="min-width:220px">
          <input id="printerDev" placeholder="Device ID (e.g. printer)" style="min-width:220px">
          <button id="savePrinter" class="btn ok">Save</button>
          <button id="testPrint" class="btn gray">Test Print</button>
          <button id="cutNow" class="btn gray">Cut Now</button>
        </div>
        <div id="printLog" class="small" style="margin-top:6px;color:#9fb0c9"></div>
        <div class="small" style="margin-top:6px">
          In Epson Web Config → <em>Configuration → ePOS‑Print</em>: Enable ePOS‑Print and set the Device ID (yours is <code>printer</code>). Make sure the cutter is enabled.
        </div>
      </div>
    </div>

    <!-- CART SIDE -->
    <div class="right">
      <div class="card">
        <h3 style="margin:0 0 8px 0">Order</h3>
        <table id="cartTable">
          <thead><tr><th>Item</th><th>Qty</th><th>Each</th><th>Line</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="total"><span>Subtotal</span><span id="subtotal">$0.00</span></div>
        <div class="row" style="justify-content:space-between;margin-top:10px">
          <button id="clearCart" class="btn gray">Clear</button>
          <button id="submitOrder" class="btn ok">Submit Order</button>
        </div>
        <div id="msg" class="muted" style="margin-top:8px"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modifier Modal -->
<div id="modMask" class="modal-mask" style="display:none">
  <div class="modal">
    <h3 id="modTitle" style="margin:0 0 6px 0">Customize</h3>
    <div id="modBody"></div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="modCancel" class="btn gray">Cancel</button>
      <button id="modAdd" class="btn ok">Add to Order</button>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script>
/* ===================== Firebase init ===================== */
firebase.initializeApp({
  apiKey:"AIzaSyBu-Ux4lvGn6-pnBngmJzL0BAtW1uIfOKM",
  authDomain:"churchfestivalpos.firebaseapp.com",
  projectId:"churchfestivalpos",
  storageBucket:"churchfestivalpos.firebasestorage.app",
  messagingSenderId:"447909610900",
  appId:"1:447909610900:web:a54a828bacfa02e7883b81"
});
const db=firebase.firestore(), auth=firebase.auth();

/* ===================== DOM refs ===================== */
const $=s=>document.querySelector(s);
const stationTabs=$('#stationTabs'), menu=$('#menu'), menuEmpty=$('#menuEmpty');
const customer=$('#customer'), search=$('#search');
const cartTBody=document.querySelector('#cartTable tbody');
const subtotalEl=$('#subtotal'), msg=$('#msg');
const me=$('#me'), loginBtn=$('#loginBtn'), logoutBtn=$('#logoutBtn');
const stationsBadge=$('#stationsBadge');
const modMask=$('#modMask'), modTitle=$('#modTitle'), modBody=$('#modBody'), modCancel=$('#modCancel'), modAdd=$('#modAdd');

/* ===== Printer UI refs ===== */
const printerIp=$('#printerIp'), printerDev=$('#printerDev'), savePrinter=$('#savePrinter'), testPrint=$('#testPrint'), autoPrint=$('#autoPrint'), cutNow=$('#cutNow');
const printLog=$('#printLog');

/* ===================== State ===================== */
let STATIONS_ALL=['Grill','Fryer','Drinks','Pizza']; // fallback
let FILTER_STATION='__ALL__';
let MENU=[]; let MOD_GROUPS=new Map(); let CART=[];

/* ===== Helpers ===== */
function setPrintLog(txt){ if(printLog) printLog.textContent = txt||''; }
function money(n){ return `$${(+n).toFixed(2)}`; }

/* ===== Printer config (localStorage) ===== */
function loadPrinterPrefs(){
  printerIp.value  = localStorage.getItem('printerIp')  || '';
  printerDev.value = localStorage.getItem('printerDev') || 'printer'; // default to your actual Device ID
  autoPrint.checked = localStorage.getItem('printerAuto') === '1';
}
function savePrinterPrefs(){
  localStorage.setItem('printerIp', (printerIp.value||'').trim());
  localStorage.setItem('printerDev',(printerDev.value||'printer').trim());
  localStorage.setItem('printerAuto', autoPrint.checked ? '1' : '0');
  alert('Printer settings saved to this device.');
}
savePrinter.onclick = savePrinterPrefs;

testPrint.onclick = async()=>{
  savePrinterPrefs();
  const ip = (printerIp.value||'').trim();
  const dev= (printerDev.value||'printer').trim();
  if(!ip){ alert('Set the printer IP first.'); return; }
  setPrintLog('Sending TEST PRINT…');
  try{
    await printRaw(`*** TEST PRINT ***\n${new Date().toLocaleString()}\n`, ip, dev);
    alert('Test print sent.');
  }catch(e){ alert('Could not reach printer — see the log below.'); }
};

cutNow.onclick = async()=>{
  const ip = (printerIp.value||'').trim();
  const dev= (printerDev.value||'printer').trim();
  if(!ip){ alert('Set the printer IP first.'); return; }
  setPrintLog('Sending CUT command…');
  try{
    await printRaw('', ip, dev); // sends feed + partial cut (see printRaw)
  }catch(e){ alert('Cut failed — see the log below.'); }
};

/* ===================== Auth UI ===================== */
auth.onAuthStateChanged(u=>{
  if(u){ me.textContent=u.email; loginBtn.style.display='none'; logoutBtn.style.display='inline-block'; }
  else { me.textContent='Signed out'; loginBtn.style.display='inline-block'; logoutBtn.style.display='none'; }
});
loginBtn.onclick=async()=>{
  const email=prompt("Email:"); if(!email) return;
  const pass=prompt("Password:"); if(pass===null) return;
  try{ await auth.signInWithEmailAndPassword(email.trim(), pass); }catch(e){ alert(e.message); }
};
logoutBtn.onclick=()=> auth.signOut();

/* ===================== Stations ===================== */
async function loadStations(){
  try{
    const snap=await db.collection('settings').doc('config').get();
    const conf=snap.data();
    if(conf && Array.isArray(conf.stations) && conf.stations.length) STATIONS_ALL=conf.stations;
  }catch(e){}
  stationTabs.innerHTML = `<button class="tab active" data-st="__ALL__">All</button>` +
    STATIONS_ALL.map(s=>`<button class="tab" data-st="${s}">${s}</button>`).join('');
  stationTabs.querySelectorAll('.tab').forEach(btn=>{
    btn.onclick=()=>{
      stationTabs.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      FILTER_STATION = btn.dataset.st;
      renderMenu();
    };
  });
  stationsBadge.textContent = 'Stations: ' + STATIONS_ALL.join(', ');
}

/* ===================== Data loads ===================== */
function loadMenu(){
  db.collection('menu').orderBy('name').onSnapshot(snap=>{
    MENU=[]; snap.forEach(d=>{ const m={id:d.id, ...d.data()}; if(m.active!==false) MENU.push(m); });
    renderMenu();
  });
}
function loadModGroups(){
  db.collection('mod_groups').onSnapshot(snap=>{
    MOD_GROUPS.clear();
    snap.forEach(d=> MOD_GROUPS.set(d.id, { id:d.id, ...d.data() }) );
  });
}

/* ===================== Render menu ===================== */
function renderMenu(){
  const q=(search.value||'').toLowerCase().trim();
  const items = MENU.filter(m=>{
    const stationOk = (FILTER_STATION==='__ALL__') || (m.station===FILTER_STATION);
    const textOk = !q || (`${m.name} ${m.station}`.toLowerCase().includes(q));
    return stationOk && textOk;
  });
  menu.innerHTML = items.map(m=>{
    const img = m.img ? `<img src="${m.img}" alt="">` : `<img src="" alt="" style="display:none">`;
    return `<div class="item" data-id="${m.id}">
      ${img}
      <div class="nm">${m.name}</div>
      <div class="pr">$${Number(m.price||0).toFixed(2)} <span class="muted">• ${m.station||''}</span></div>
    </div>`;
  }).join('');
  menuEmpty.style.display = items.length? 'none':'block';
  menu.querySelectorAll('.item').forEach(el=> el.onclick = ()=> onMenuClick(el.dataset.id));
}
search.oninput=renderMenu;

/* ===================== Add to cart (with modifiers) ===================== */
function onMenuClick(menuId){
  const m = MENU.find(x=>x.id===menuId);
  if(!m) return;
  const groupIds = Array.isArray(m.modGroupIds) ? m.modGroupIds.filter(Boolean) : [];
  if(!groupIds.length){
    addLine({menuId:m.id, name:m.name, station:m.station, basePrice:+m.price||0, mods:[]});
    return;
  }
  openModifierModal(m, groupIds);
}
function openModifierModal(menuItem, groupIds){
  modTitle.textContent = `Customize: ${menuItem.name}`;
  modBody.innerHTML = '';
  const groups = groupIds.map(id=> MOD_GROUPS.get(id)).filter(Boolean);
  if(!groups.length){
    addLine({menuId:menuItem.id, name:menuItem.name, station:menuItem.station, basePrice:+menuItem.price||0, mods:[]});
    return;
  }
  groups.forEach((g, idx)=>{
    const gid = `g${idx}`;
    const row = document.createElement('div');
    row.innerHTML = `<div style="margin:6px 0 4px 0;font-weight:600">${g.name}</div>`;
    const box = document.createElement('div');
    (g.options||[]).forEach((opt, i)=>{
      if(g.selectType === 'single'){
        const line = document.createElement('label'); line.className='opt';
        line.innerHTML = `<span><input type="radio" name="${gid}" value="${i}"> ${opt.name}</span>
                          <span class="muted">${opt.price?`+$${Number(opt.price).toFixed(2)}`:''}</span>`;
        box.appendChild(line);
      }else{
        const line = document.createElement('label'); line.className='opt';
        line.innerHTML = `<span><input type="checkbox" data-g="${gid}" value="${i}"> ${opt.name}</span>
                          <span class="muted">${opt.price?`+$${Number(opt.price).toFixed(2)}`:''}</span>`;
        box.appendChild(line);
      }
    });
    if(g.selectType==='multi' && g.maxPicks){
      const info=document.createElement('div'); info.className='muted'; info.style.marginTop='4px';
      info.textContent = `Pick up to ${g.maxPicks}`; box.appendChild(info);
      box.addEventListener('change', ()=>{
        const checked = box.querySelectorAll('input[type=checkbox]:checked');
        if(checked.length > (g.maxPicks||0)){ checked[checked.length-1].checked=false; alert(`You can pick up to ${g.maxPicks}`); }
      });
    }
    row.appendChild(box); modBody.appendChild(row);
  });
  modMask.style.display='flex';
  modCancel.onclick = ()=> { modMask.style.display='none'; };
  modAdd.onclick = ()=>{
    const selection = []; let addPrice = 0;
    groups.forEach((g, idx)=>{
      const gid=`g${idx}`; const chosen=[];
      if(g.selectType==='single'){
        const picked = modBody.querySelector(`input[name="${gid}"]:checked`);
        if(picked){ const opt=g.options[+picked.value]; chosen.push({name:opt.name,price:+opt.price||0}); }
      }else{
        [...modBody.querySelectorAll(`input[type=checkbox][data-g="${gid}"]:checked`)]
          .forEach(c=>{ const opt=g.options[+c.value]; chosen.push({name:opt.name,price:+opt.price||0}); });
      }
      chosen.forEach(o=> addPrice += (o.price||0));
      selection.push({ groupName:g.name, options:chosen });
    });
    addLine({ menuId:menuItem.id, name:menuItem.name, station:menuItem.station, basePrice:+menuItem.price||0, mods:selection });
    modMask.style.display='none';
  };
}
function addLine({menuId,name,station,basePrice,mods}){
  const modSum = (mods||[]).flatMap(g=>g.options||[]).reduce((a,b)=> a + (+b.price||0), 0);
  const each = (+basePrice||0) + modSum;
  const keyMods = JSON.stringify(mods||[]);
  const existing = CART.find(l => l.menuId===menuId && JSON.stringify(l.mods||[])===keyMods);
  if(existing){ existing.qty += 1; existing.eachPrice=each; existing.lineTotal=existing.qty*each; }
  else{ CART.push({menuId,name,station,qty:1,basePrice:+basePrice||0,mods:mods||[],eachPrice:each,lineTotal:each}); }
  renderCart();
}

/* ===================== Cart ===================== */
function renderCart(){
  cartTBody.innerHTML = CART.map((l, idx)=>{
    const modsHtml = (l.mods&&l.mods.length)
      ? `<div class="muted" style="font-size:12px;margin-top:2px">${l.mods.map(g=>`${g.groupName}: ${g.options.map(o=>o.name).join(', ')}`).join(' • ')}</div>` : '';
    return `<tr>
      <td><div style="font-weight:600">${l.name}</div>${modsHtml}<div class="muted" style="font-size:11px">${l.station||''}</div></td>
      <td><button class="qbtn" data-dec="${idx}">−</button><span style="display:inline-block;width:26px;text-align:center">${l.qty}</span><button class="qbtn" data-inc="${idx}">+</button></td>
      <td>$${l.eachPrice.toFixed(2)}</td><td>$${(l.eachPrice*l.qty).toFixed(2)}</td>
      <td><button class="btn danger" data-del="${idx}">Remove</button></td></tr>`;
  }).join('');
  cartTBody.querySelectorAll('[data-inc]').forEach(b=> b.onclick=()=>{ CART[+b.dataset.inc].qty++; recalc(); });
  cartTBody.querySelectorAll('[data-dec]').forEach(b=> b.onclick=()=>{ const i=+b.dataset.dec; CART[i].qty=Math.max(1,CART[i].qty-1); recalc(); });
  cartTBody.querySelectorAll('[data-del]').forEach(b=> b.onclick=()=>{ CART.splice(+b.dataset.del,1); recalc(); });
  recalc();
}
function recalc(){ CART.forEach(l=> l.lineTotal=l.qty*l.eachPrice); const sub=CART.reduce((a,b)=>a+b.lineTotal,0); subtotalEl.textContent=`$${sub.toFixed(2)}`; }

/* ===================== Order submit ===================== */
async function nextOrderNumber(){
  const ref=db.collection('meta').doc('order_seq');
  const num=await db.runTransaction(async tx=>{ const snap=await tx.get(ref); let v=(snap.exists&&typeof snap.data().value==='number')?snap.data().value:0; v=v+1; tx.set(ref,{value:v},{merge:true}); return v; });
  return num;
}
$('#clearCart').onclick=()=>{ CART=[]; renderCart(); };
$('#submitOrder').onclick = async ()=>{
  if(!CART.length){ alert('Cart is empty'); return; }
  const cust=(customer.value||'').trim(); if(!cust){ alert('Please enter the customer name.'); customer.focus(); return; }
  try{
    msg.textContent='Submitting...';
    const number=await nextOrderNumber(); const ts=Date.now();
    const order={ number, status:'new', createdAt:ts, updatedAt:ts, customer:cust,
      total:CART.reduce((a,b)=>a+b.lineTotal,0),
      items:CART.map(l=>({ menuId:l.menuId, name:l.name, qty:l.qty, price:l.eachPrice, station:l.station||null,
        mods:(l.mods||[]).map(g=>({ groupName:g.groupName, options:(g.options||[]).map(o=>({name:o.name,price:+o.price||0})) }))
      }))
    };
    await db.collection('orders').add(order);
    if(autoPrint.checked){ await printReceipt(order); }
    CART=[]; renderCart(); customer.value=''; msg.textContent=`Order #${number} placed!`; setTimeout(()=> msg.textContent='', 2000);
  }catch(e){ msg.textContent='Error: '+e.message; }
};

/* ===================== Epson ePOS‑Print ===================== */
/** Pretty 42‑column receipt for 80mm */
function fmtReceipt(order){
  const width=42;
  const line = '─'.repeat(width);
  const center = s => {
    s=String(s); const pad=Math.max(0, Math.floor((width - s.length)/2));
    return ' '.repeat(pad)+s;
  };
  const money = n => '$'+(+n).toFixed(2);
  const right = (l,r) => { l=String(l); r=String(r); const spaces=Math.max(1,width-l.length-r.length); return l+' '.repeat(spaces)+r; };

  const rows=[];
  rows.push(center('FESTIVAL POS'));
  rows.push(center(`Order #${order.number}`));
  rows.push(center(new Date().toLocaleString()));
  rows.push(line);

  order.items.forEach(it=>{
    const amt = money(it.price*it.qty);
    rows.push(right(`${it.qty}× ${it.name}`, amt));
    const mods=(it.mods||[]).flatMap(g=>(g.options||[]).map(o=>o.name));
    if(mods.length){
      const m='('+mods.join(', ')+')';
      let s=m;
      while(s.length>width){ rows.push('  '+s.slice(0,width-2)); s=s.slice(width-2); }
      rows.push('  '+s);
    }
  });

  rows.push(line);
  rows.push(right('TOTAL', money(order.total)));
  rows.push('');
  rows.push(center('Thank you!'));
  rows.push('');
  return rows.join('\n');
}

/** Send text to printer with FEED + PARTIAL CUT (works on TM‑m30II) */
async function printRaw(text, ip, devid){
  const url=`http://${ip}/cgi-bin/epos/service.cgi?devid=${encodeURIComponent(devid)}&timeout=60000`;
  const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  const xml=`<?xml version="1.0" encoding="utf-8"?>
<epos-print xmlns="http://www.epson-pos.com/schemas/2011/03/epos-print">
  <text lang="en" smooth="true" font="font_a" width="1" height="1">${esc(text)}</text>
  <feed line="5"/>
  <cut type="partial"/>
</epos-print>`;

  setPrintLog('Sending job…');
  try{
    const res=await fetch(url,{method:"POST",headers:{"Content-Type":"text/xml"},body:xml});
    const t=await res.text();
    console.log('Printer response:', t);
    setPrintLog('Printer response: '+t);
    return t;
  }catch(err){
    console.error('Printer error', err);
    setPrintLog('Printer error: '+ String(err));
    throw err;
  }
}

async function printReceipt(order){
  const ip=(localStorage.getItem('printerIp')||'').trim();
  const dev=(localStorage.getItem('printerDev')||'printer').trim();
  if(!ip){ console.warn('No printer IP set; skipping print'); return; }
  const body = fmtReceipt(order);
  try{
    await printRaw(body, ip, dev);
  }catch(err){
    alert('Could not print (see log under the buttons).');
  }
}

/* ===================== Boot ===================== */
loadPrinterPrefs();
loadStations();
loadMenu();
loadModGroups();
</script>
</body></html>
