<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Modifier Groups Admin</title>
<style>
  :root{--bg:#0d0f13;--fg:#f5f7fa;--muted:#95a0ad;--accent:#5b9bff;--ok:#2fd28f;--warn:#ffb020;--danger:#ff6b6b;--card:#0f141e;--border:#1b2230}
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
  .col2{display:grid;grid-template-columns:420px 1fr;gap:14px}
  input,select{font:inherit;background:#121826;color:#eaf0f6;border:1px solid var(--border);border-radius:10px;padding:10px 12px}
  .btn{border:none;border-radius:10px;padding:10px 12px;cursor:pointer;color:#fff;background:var(--accent)}
  .btn.ok{background:var(--ok);color:#0b0e14}
  .btn.gray{background:#1e2432}
  .btn.danger{background:var(--danger);color:#0b0e14}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left;vertical-align:top}
  .small{font-size:12px;color:var(--muted)}
  .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:6px 10px;color:#aab3c0}
  .opt-row{display:grid;grid-template-columns:1fr 120px 36px;gap:8px;margin-bottom:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between">
    <h2>Modifier Groups Admin</h2>
    <span id="me" class="pill">Not signed in</span>
  </div>

  <!-- Auth -->
  <div class="card" id="auth">
    <div class="row">
      <input id="email" type="email" placeholder="Admin email" style="flex:1;min-width:220px">
      <input id="pass" type="password" placeholder="Password" style="flex:1;min-width:160px">
      <button id="login" class="btn">Sign in</button>
      <button id="logout" class="btn gray">Sign out</button>
    </div>
    <div id="msg" class="small" style="margin-top:6px"></div>
  </div>

  <div class="col2">
    <!-- Editor -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">Edit Group</h3>
      <div class="small" id="editHint" style="margin-bottom:8px">Creating new group</div>
      <input id="gName" placeholder="Group name (e.g., Pick 3 meats)" style="width:100%;margin-bottom:8px">
      <div class="row">
        <label>Type:
          <select id="gType">
            <option value="single">Single (choose one)</option>
            <option value="multi">Multi (choose many)</option>
          </select>
        </label>
        <label id="maxWrap">Max picks:
          <input id="gMax" type="number" min="1" value="1" style="width:100px">
        </label>
      </div>

      <h4 style="margin:12px 0 6px">Options</h4>
      <div id="opts"></div>
      <button id="addOpt" class="btn gray" style="margin-top:6px">+ Add option</button>

      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button id="resetForm" class="btn gray">Reset</button>
        <button id="save" class="btn ok">Save Group</button>
        <button id="delete" class="btn danger" style="display:none">Delete</button>
      </div>
      <div id="saveMsg" class="small" style="margin-top:6px"></div>
    </div>

    <!-- List -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">Existing Groups</h3>
      <table id="tbl">
        <thead>
          <tr><th>Name</th><th>Type</th><th>Max</th><th>Options</th><th>ID</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="small" style="margin-top:6px">Tip: Click “Edit” to load into the left form. Copy the ID to attach to items.</div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey: "AIzaSyBu-Ux4lvGn6-pnBngmJzL0BAtW1uIfOKM",
  authDomain: "churchfestivalpos.firebaseapp.com",
  projectId: "churchfestivalpos"
});
const db=firebase.firestore(), auth=firebase.auth();

const ADMINS = new Set(["smsmofri@gmail.com","george.henin98@gmail.com"].map(x=>x.toLowerCase()));

const $=s=>document.querySelector(s);
const me=$('#me'), msg=$('#msg'), authBox=$('#auth'), login=$('#login'), logout=$('#logout'), email=$('#email'), pass=$('#pass');

const gName=$('#gName'), gType=$('#gType'), gMax=$('#gMax'), maxWrap=$('#maxWrap');
const optsBox=$('#opts'), addOpt=$('#addOpt'), save=$('#save'), delBtn=$('#delete'), saveMsg=$('#saveMsg'), editHint=$('#editHint');
const tblBody=document.querySelector('#tbl tbody'), resetForm=$('#resetForm');

let editingId=null;

auth.onAuthStateChanged(u=>{
  const ok = !!(u && ADMINS.has((u.email||"").toLowerCase()));
  me.textContent = u ? u.email : 'Not signed in';
  authBox.style.display='block';
  document.querySelectorAll('.col2,.card').forEach(el=>{
    if(el!==authBox) el.style.display = ok ? '' : 'none';
  });
  if(ok) subscribe();
});
login.onclick=async()=>{ msg.textContent='Signing in...'; try{await auth.signInWithEmailAndPassword(email.value.trim(), pass.value); msg.textContent='Signed in.';}catch(e){msg.textContent=e.message;} };
logout.onclick=()=> auth.signOut();

gType.onchange=()=> maxWrap.style.display = (gType.value==='multi') ? '' : 'none';

function addOptionRow(name='', price=''){
  const row=document.createElement('div');
  row.className='opt-row';
  row.innerHTML=`
    <input placeholder="Option name" value="${name}">
    <input type="number" step="0.01" placeholder="Price (can be 0)" value="${price}">
    <button class="btn danger">×</button>
  `;
  row.querySelector('button').onclick=()=> row.remove();
  optsBox.appendChild(row);
}

addOpt.onclick=()=> addOptionRow();

resetForm.onclick=()=>{
  editingId=null; editHint.textContent='Creating new group';
  gName.value=''; gType.value='single'; gMax.value='1'; gType.onchange();
  optsBox.innerHTML=''; addOptionRow(); addOptionRow();
  delBtn.style.display='none'; saveMsg.textContent='';
};

resetForm.onclick(); // init

async function saveGroup(){
  const name=(gName.value||'').trim();
  const type=gType.value;
  const max= parseInt(gMax.value||'0',10);
  const options=[...optsBox.children].map(r=>{
    const [n,p]=r.querySelectorAll('input');
    return {name:n.value.trim(), price: parseFloat(p.value||'0')||0};
  }).filter(o=>o.name);

  if(!name){ saveMsg.textContent='Name is required'; return; }
  if(type==='multi' && (!max || max<1)){ saveMsg.textContent='Max picks must be 1 or more for Multi.'; return; }
  if(!options.length){ saveMsg.textContent='Add at least one option.'; return; }

  const payload={ name, selectType:type, maxPicks: (type==='multi'? max : null), options };

  try{
    saveMsg.textContent='Saving...';
    if(editingId){
      await db.collection('mod_groups').doc(editingId).set(payload, {merge:true});
    }else{
      const ref=await db.collection('mod_groups').add(payload);
      editingId=ref.id;
    }
    saveMsg.textContent='Saved.';
    delBtn.style.display='inline-block';
  }catch(e){ saveMsg.textContent=e.message; }
}
save.onclick=saveGroup;

delBtn.onclick=async()=>{
  if(!editingId) return;
  if(!confirm('Delete this group?')) return;
  try{
    await db.collection('mod_groups').doc(editingId).delete();
    resetForm.click();
  }catch(e){ alert(e.message); }
};

function subscribe(){
  db.collection('mod_groups').orderBy('name').onSnapshot(snap=>{
    tblBody.innerHTML='';
    snap.forEach(d=>{
      const g=d.data();
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${g.name||''}</td>
        <td>${g.selectType||''}</td>
        <td>${g.selectType==='multi' ? (g.maxPicks||'') : ''}</td>
        <td>${(g.options||[]).map(o=>o.name).join(', ')}</td>
        <td class="small">${d.id}</td>
        <td><button class="btn gray" data-edit="${d.id}">Edit</button></td>
      `;
      tr.querySelector('[data-edit]').onclick=async()=>{
        editingId=d.id; editHint.textContent='Editing: '+(g.name||'');
        gName.value=g.name||''; gType.value=g.selectType||'single'; gType.onchange();
        gMax.value=g.maxPicks||1;
        optsBox.innerHTML=''; (g.options||[]).forEach(o=> addOptionRow(o.name||'', o.price||0));
        if(!optsBox.children.length) addOptionRow();
        delBtn.style.display='inline-block'; saveMsg.textContent='';
        window.scrollTo({top:0, behavior:'smooth'});
      };
      tblBody.appendChild(tr);
    });
  });
}
</script>
</body>
</html>
