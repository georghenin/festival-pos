<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Printer Module</title>
<style>
  :root{--bg:#0d0f13;--fg:#f5f7fa;--muted:#95a0ad;--card:#0f141e;--border:#1b2230;--ok:#2fd28f;--warn:#ffb020}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:900px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button,textarea{font:inherit}
  input{background:#121826;color:#eaf0f6;border:1px solid var(--border);border-radius:10px;padding:10px 12px}
  button{border:none;border-radius:10px;padding:10px 12px;cursor:pointer;color:#0b0e14}
  .btn{background:#5b9bff;color:#fff}.ok{background:var(--ok)}.warn{background:var(--warn)}.gray{background:#1e2432;color:#e5e8ee}
  .small{color:var(--muted);font-size:12px}
  textarea{width:100%;min-height:160px;background:#0e1623;color:#eaf0f6;border:1px solid var(--border);border-radius:12px;padding:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2 style="margin:0 0 10px 0">Printer Module</h2>
    <div class="row">
      <input id="ip" placeholder="Printer IP (e.g. 192.168.6.255)" style="min-width:220px">
      <input id="devid" placeholder="Device ID (e.g. printer)" style="min-width:160px">
      <button id="save" class="ok">Save</button>
      <button id="test" class="gray">Test</button>
      <button id="forceCut" class="warn" title="Feed a few lines then cut">Force Cut</button>
    </div>
    <div class="small" style="margin-top:6px">
      Make sure: Epson Web Config → <em>Configuration</em> → <b>ePOS‑Print</b> is Enabled and Device ID matches.
    </div>
    <div style="margin-top:10px">
      <div class="small">Printer response:</div>
      <textarea id="log" readonly></textarea>
    </div>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);
const ipEl=$('#ip'), devEl=$('#devid'), logEl=$('#log');

function loadPrefs(){
  ipEl.value = localStorage.getItem('printerIp') || '';
  devEl.value = localStorage.getItem('printerDev') || 'printer';
}
function savePrefs(){
  localStorage.setItem('printerIp', ipEl.value.trim());
  localStorage.setItem('printerDev', devEl.value.trim() || 'printer');
  write('Saved.');
}
function write(t){ logEl.value = t; logEl.scrollTop = logEl.scrollHeight; }

async function postXml(url, body){
  try{
    const r = await fetch(url, {method:'POST', headers:{'Content-Type':'text/xml; charset=utf-8'}, body});
    return await r.text();
  }catch(e){ return 'FETCH ERROR: '+e.message; }
}

// Variant A6 (the one that worked for you): SOAP → /cgi-bin/epos/service.cgi with inner epos-print
function buildXML(inner){
  return `<?xml version="1.0" encoding="utf-8"?>
<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
  <s:Body>
${inner}
  </s:Body>
</s:Envelope>`;
}
function innerPrintXML(text){
  // Escape text for XML
  const esc = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return `<epos-print xmlns="http://www.epson-pos.com/schemas/2011/03/epos-print">
  <text lang="en" smooth="true" font="font_a" width="1" height="1">${esc}</text>
  <feed line="6"/>
  <cut type="partial"/>
</epos-print>`;
}

async function sendToPrinter(text, doCut=true){
  const ip=(ipEl.value||'').trim();
  const devid=(devEl.value||'').trim() || 'printer';
  if(!ip){ write('Missing IP'); return; }

  // 1) Preferred: service.cgi + SOAP (your A6 success path)
  const inner = doCut ? innerPrintXML(text) : innerPrintXML(text.replace(/\n+$/,'')+'\n');
  const soap  = buildXML(inner);
  const url1  = `http://${ip}/cgi-bin/epos/service.cgi?devid=${encodeURIComponent(devid)}&timeout=60000`;
  let res = await postXml(url1, soap);
  write(res);

  // If SchemaError, try the raw /cgi-bin/epos/print (some firmwares want that)
  if(/SchemaError/i.test(res) || /Not Found/i.test(res)){
    const url2 = `http://${ip}/cgi-bin/epos/print?devid=${encodeURIComponent(devid)}&timeout=60000`;
    res = await postXml(url2, soap);
    write(res + '\n\n(fallback /epos/print tried)');
  }
}

// UI buttons
$('#save').onclick = savePrefs;
$('#test').onclick = ()=> sendToPrinter(`*** TEST PRINT ***\n${new Date().toLocaleString()}\n`);
$('#forceCut').onclick = ()=> sendToPrinter('\n', true);

// Listen for POS → postMessage
window.addEventListener('message', (ev)=>{
  const data = ev.data || {};
  if(data && data.cmd === 'print'){
    if(data.ip) ipEl.value = data.ip;
    if(data.devid) devEl.value = data.devid;
    if(data.save) savePrefs();
    sendToPrinter(String(data.text||''), data.cut!==false);
  }else if(data && data.cmd === 'cut'){
    sendToPrinter('\n', true);
  }
});

// Optional: querystring auto
function getQ(k){ return new URLSearchParams(location.search).get(k); }
window.addEventListener('DOMContentLoaded', ()=>{
  loadPrefs();
  const auto = getQ('auto');
  if(auto==='1'){
    const text = decodeURIComponent(getQ('text')||'');
    const ip   = getQ('ip')||'';
    const dev  = getQ('devid')||'';
    if(ip) ipEl.value = ip;
    if(dev) devEl.value = dev;
    sendToPrinter(text, true);
  }
});
</script>
</body>
</html>
