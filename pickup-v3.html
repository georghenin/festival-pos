<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pickup Display</title>
<style>
  :root{--bg:#0d0f13;--fg:#f5f7fa;--muted:#95a0ad;--border:#1b2230}
  html,body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;height:100%}
  .wrap{height:100vh;display:flex;flex-direction:column}
  .top{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
  .grid{flex:1;display:grid;gap:16px;padding:16px;overflow:auto}
  .tile{background:#121826;border:1px solid var(--border);border-radius:18px;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;min-height:160px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:10px}
  .num{font-size:54px;font-weight:800;letter-spacing:1px;line-height:1}
  .cust{margin-top:6px;font-size:18px;color:#e5e8ee}
  .meta{position:absolute;bottom:8px;right:10px;font-size:11px;color:#95a0ad}
  .foot{padding:10px 16px;border-top:1px solid var(--border);display:flex;justify-content:space-between;font-size:12px;color:#95a0ad}
  .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;color:#95a0ad}
  label input{margin-right:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h2 style="margin:0">Order Pickup</h2>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <span id="count" class="pill">Ready: 0</span>
      <label class="pill" style="cursor:pointer"><input type="checkbox" id="soundToggle"> Sound</label>
    </div>
  </div>
  <div class="grid" id="grid"></div>
  <div class="foot"><span>Watch for your name/number.</span><span id="time">—</span></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey: "AIzaSyBu-Ux4lvGn6-pnBngmJzL0BAtW1uIfOKM",
  authDomain: "churchfestivalpos.firebaseapp.com",
  projectId: "churchfestivalpos",
  storageBucket: "churchfestivalpos.firebasestorage.app",
  messagingSenderId: "447909610900",
  appId: "1:447909610900:web:a54a828bacfa02e7883b81"
});
const db=firebase.firestore();

const grid=document.getElementById('grid');
const count=document.getElementById('count');
const timeEl=document.getElementById('time');
const soundToggle=document.getElementById('soundToggle');

let SOUND_ON=false;
soundToggle.onchange = ()=>{ SOUND_ON = soundToggle.checked; if(SOUND_ON) chime(true); };

function chime(test=false){ try{
  if(!SOUND_ON && !test) return;
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const o=ctx.createOscillator(), g=ctx.createGain();
  o.type='sine';o.frequency.value=880;o.connect(g);g.connect(ctx.destination);
  g.gain.value=0.0001; g.gain.exponentialRampToValueAtTime(0.25, ctx.currentTime+0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.35);
  o.start(); o.stop(ctx.currentTime+0.4);
} catch(e){} }
function fmtAgo(ts){ if(!ts) return '—'; const m=Math.floor((Date.now()-ts)/60000); return m<1?'now':m+'m'; }

let newest=0, first=true;
// Single orderBy avoids composite index; filter status client-side.
db.collection('orders').orderBy('readyAt','desc').limit(200).onSnapshot(s=>{
  const arr=[];
  s.forEach(d=>{
    const o={id:d.id, ...d.data()};
    if(o.status==='ready') arr.push(o);
  });
  grid.innerHTML = arr.map(o=>`
    <div class="tile">
      <div class="num">#${o.number}</div>
      <div class="cust">${o.customer?o.customer:''}</div>
      <div class="meta">${fmtAgo(o.readyAt)}</div>
    </div>`).join('');
  count.textContent='Ready: '+arr.length;
  timeEl.textContent='Last sync: '+new Date().toLocaleTimeString();
  const latest = arr.reduce((m,o)=>Math.max(m, o.readyAt||0), 0);
  if(!first && latest>newest) chime();
  newest=Math.max(newest, latest); first=false;
}, err=>{
  grid.innerHTML = `<div style="color:#95a0ad">Error: ${err.message}</div>`;
});
</script>
</body></html>
