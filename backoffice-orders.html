<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Back Office — Orders</title>
<style>
  :root{
    --bg:#0d0f13; --card:#0f141e; --fg:#f5f7fa; --muted:#95a0ad;
    --border:#1b2230; --accent:#5b9bff; --ok:#2fd28f; --warn:#ffb020; --danger:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;background:#0d0f13d0;backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;gap:10px;align-items:center;z-index:5}
  h1{margin:0;font-size:18px}
  input,select,button{background:#0c111b;color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
  button{cursor:pointer}
  .primary{background:var(--accent);color:#fff;border:none}
  .ghost{background:#0c111b}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .grid.head,.grid.row{display:grid;grid-template-columns:2fr 0.8fr 1fr 1.6fr 0.9fr 0.8fr;gap:8px;padding:10px 12px;align-items:center}
  .grid.head{position:sticky;top:66px;background:#0d0f13;border-bottom:1px solid var(--border);font-weight:600;color:#cbd5e1;z-index:4}
  .grid.row{border-bottom:1px solid #0e1320}
  .grid.row:hover{background:#0b101a}
  .pill{display:inline-block;border:1px solid var(--border);background:#0f1420;color:#a7b0bd;border-radius:999px;padding:4px 8px;font-size:12px}
  .pill.ok{color:#0b0e14;background:var(--ok);border:none}
  .pill.bad{color:#0b0e14;background:var(--danger);border:none}
  .muted{color:var(--muted);font-size:13px}
  dialog{width:min(920px,92vw);border:1px solid var(--border);border-radius:16px;padding:0;background:var(--card);color:var(--fg)}
  dialog header{display:flex;gap:8px;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border)}
  .modal-body{max-height:70vh;overflow:auto;padding:14px}
  .kv{display:grid;grid-template-columns:160px 1fr;gap:6px 12px;margin-bottom:12px}
  .items{border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-top:8px}
  .items .h,.items .r{display:grid;grid-template-columns:1.6fr 0.6fr 0.7fr 0.8fr;gap:8px;padding:10px 12px}
  .items .h{background:#0c111b;border-bottom:1px solid var(--border);font-weight:600;color:#cbd5e1}
  .items .r{border-bottom:1px solid #0e1320}
  .danger{background:var(--danger);border:none;color:#0b0e14}
  .okbtn{background:var(--ok);border:none;color:#0b0e14}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
</style>
</head>
<body>
  <header>
    <h1>Back Office — Orders</h1>
    <input id="search" placeholder="Search by customer name…"/>
    <input id="from" type="date"/><input id="to" type="date"/>
    <select id="status">
      <option value="any">Any status</option>
      <option value="active">active</option>
      <option value="ready">ready</option>
      <option value="picked_up">picked_up</option>
      <option value="archived">archived</option>
      <option value="refunded">refunded</option>
    </select>
    <button id="apply" class="primary">Apply</button>
    <div style="flex:1"></div>
    <a href="backoffice-analytics.html"><button class="ghost">Analytics</button></a>
  </header>

  <div class="wrap">
    <div class="grid head">
      <div>Customer</div><div>Total</div><div>Station</div><div>Created</div><div>Status</div><div>Action</div>
    </div>
    <div id="list"></div>
    <div id="empty" class="muted" style="display:none;padding:14px">No orders match your filters.</div>
    <div style="text-align:center;margin-top:12px">
      <button id="more" class="ghost" style="display:none">Load more…</button>
    </div>
  </div>

  <dialog id="dlg">
    <header>
      <h1 style="font-size:16px;margin:0">Order Details</h1>
      <div style="flex:1"></div>
      <button id="close" class="ghost">Close</button>
    </header>
    <div class="modal-body">
      <div class="kv">
        <div class="muted">Order ID</div><div id="m_id">—</div>
        <div class="muted">Customer</div><div id="m_cust">—</div>
        <div class="muted">Total</div><div id="m_total">—</div>
        <div class="muted">Station</div><div id="m_station">—</div>
        <div class="muted">Created</div><div id="m_created">—</div>
        <div class="muted">Status</div><div id="m_status">—</div>
        <div class="muted">Ticket #</div><div id="m_number">—</div>
      </div>

      <div class="items">
        <div class="h"><div>Item / Variant</div><div>Qty</div><div>Price</div><div>Line</div></div>
        <div id="m_items"></div>
      </div>

      <div style="margin-top:12px" class="row">
        <button id="toPickup"   class="okbtn">Send to Pickup</button>
        <button id="toKitchen"  class="ghost">Send to Kitchen</button>
        <button id="forceDone"  class="ghost">Force Complete (Archive)</button>
        <button id="refund"     class="danger">Refund Order</button>
        <span class="muted">Archived/refunded orders won’t show on KDS or Pickup. Refunded orders are excluded from Sales.</span>
      </div>
    </div>
  </dialog>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script>
  // ---------- config ----------
  const ADMIN_EMAILS = ["smsmofri@gmail.com","george.henin98@gmail.com"]; // extend if needed
  const config = { apiKey:"AIzaSyBu-Ux4lvGn6-pnBngmJzL0BAtW1uIfOKM", authDomain:"churchfestivalpos.firebaseapp.com", projectId:"churchfestivalpos" };
  firebase.initializeApp(config);
  const db = firebase.firestore();
  const auth = firebase.auth();

  // ---------- UI refs ----------
  const elList = document.getElementById("list");
  const elEmpty = document.getElementById("empty");
  const elMore = document.getElementById("more");
  const elSearch = document.getElementById("search");
  const elFrom = document.getElementById("from");
  const elTo = document.getElementById("to");
  const elStatus = document.getElementById("status");
  const elApply = document.getElementById("apply");

  // dialog refs
  const dlg = document.getElementById("dlg");
  const btnClose = document.getElementById("close");
  const btnRefund = document.getElementById("refund");
  const btnToPickup = document.getElementById("toPickup");
  const btnToKitchen = document.getElementById("toKitchen");
  const btnForceDone = document.getElementById("forceDone");
  const m_id = document.getElementById("m_id");
  const m_cust = document.getElementById("m_cust");
  const m_total = document.getElementById("m_total");
  const m_station = document.getElementById("m_station");
  const m_created = document.getElementById("m_created");
  const m_status = document.getElementById("m_status");
  const m_number = document.getElementById("m_number");
  const m_items = document.getElementById("m_items");

  // ---------- helpers ----------
  const fmt = n => `$${(Number(n||0)).toFixed(2)}`;
  const tsText = ms => ms ? new Date(ms).toLocaleString() : "—";
  function lineTotal(qty, price){ return Number(qty||1) * Number(price||0); }

  function itemLines(it){
    const baseName = it.name || "—";
    const qty = Number(it.qty || 1);
    const price = Number(it.price || 0);
    const lines = [{ label: baseName, qty, price }];

    const mods = it.mods;
    if (Array.isArray(mods) && mods.length && mods[0]?.options) {
      mods.forEach(g=>{
        (g.options||[]).forEach(opt=>{
          lines.push({ label: `${baseName} – ${g.groupName}: ${opt.name}`, qty, price: Number(opt.price||0) });
        });
      });
    } else if (Array.isArray(mods)) {
      mods.forEach(m=>{
        lines.push({ label: `${baseName} – ${m.name}`, qty: Number(m.qty||qty), price: Number(m.price||0) });
      });
    } else if (mods && typeof mods === 'object') {
      lines.push({ label: `${baseName} – ${mods.name}`, qty: Number(mods.qty||qty), price: Number(mods.price||0) });
    }
    return lines;
  }

  // ---------- state ----------
  let buffer = [];       // cached docs for client filtering
  let lastDoc = null;    // for pagination
  let unsub = null;      // live listener (first page)

  // default dates (last 7 days)
  const today = new Date();
  const start = new Date(); start.setDate(today.getDate()-6);
  elFrom.value = start.toISOString().slice(0,10);
  elTo.value = today.toISOString().slice(0,10);

  // load first page live (latest 1000)
  async function loadFirst(){
    if (unsub) unsub();
    buffer = []; lastDoc = null;
    elList.innerHTML = ""; elEmpty.style.display = "none";
    const q = db.collection("orders").orderBy("createdAt","desc").limit(1000);
    unsub = q.onSnapshot(snap=>{
      buffer = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      applyFilters();
      lastDoc = snap.docs[snap.docs.length-1] || null;
      elMore.style.display = lastDoc ? "inline-block" : "none";
    });
  }

  // load more (older) once, not live
  async function loadMore(){
    if (!lastDoc) return;
    const q = db.collection("orders").orderBy("createdAt","desc").startAfter(lastDoc).limit(1000);
    const snap = await q.get();
    buffer = buffer.concat(snap.docs.map(d=>({ id:d.id, ...d.data() })));
    applyFilters();
    lastDoc = snap.docs[snap.docs.length-1] || null;
    elMore.style.display = lastDoc ? "inline-block" : "none";
  }

  function applyFilters(){
    const q = (elSearch.value||"").trim().toLowerCase();
    const s = elStatus.value;
    const fd = elFrom.value ? new Date(elFrom.value+"T00:00:00").getTime() : null;
    const td = elTo.value ? new Date(elTo.value+"T23:59:59").getTime() : null;

    const rows = buffer.filter(o=>{
      if (q && !(o.customer||"").toLowerCase().includes(q)) return false;
      if (s !== "any" && (o.status||"") !== s) return false;
      const ms = o.createdAt || 0;
      if (fd && ms < fd) return false;
      if (td && ms > td) return false;
      return true;
    });

    elList.innerHTML = "";
    if (!rows.length){ elEmpty.style.display = "block"; return; }
    elEmpty.style.display = "none";

    rows.forEach(o=>{
      const row = document.createElement("div");
      row.className = "grid row";
      row.innerHTML = `
        <div>${o.customer||"—"}</div>
        <div>${fmt(o.total)}</div>
        <div>${o.station||"—"}</div>
        <div>${tsText(o.createdAt)}</div>
        <div>${o.status==="refunded" ? '<span class="pill bad">refunded</span>' :
                 o.status==="picked_up" ? '<span class="pill ok">picked_up</span>' :
                 o.status==="archived"  ? '<span class="pill">archived</span>' :
                 `<span class="pill">${o.status||"—"}</span>`}</div>
        <div><button class="ghost" data-id="${o.id}">Open</button></div>`;
      row.querySelector("button").addEventListener("click", ()=>openModal(o.id));
      elList.appendChild(row);
    });
  }

  async function openModal(id){
    const o = buffer.find(x=>x.id===id);
    if (!o) return;

    // stash current selection on buttons
    [btnRefund, btnToPickup, btnToKitchen, btnForceDone].forEach(b=>{ b.dataset.id = id; });

    m_id.textContent = id;
    m_cust.textContent = o.customer || "—";
    m_total.textContent = fmt(o.total);
    m_station.textContent = o.station || "—";
    m_created.textContent = tsText(o.createdAt);
    m_status.textContent = o.status || "—";
    m_number.textContent = o.number ?? "—";

    m_items.innerHTML = "";
    (Array.isArray(o.items) ? o.items : []).forEach(it=>{
      itemLines(it).forEach(L=>{
        const div = document.createElement("div");
        div.className = "r";
        div.innerHTML = `<div>${L.label}</div><div>${L.qty}</div><div>${fmt(L.price)}</div><div>${fmt(lineTotal(L.qty,L.price))}</div>`;
        m_items.appendChild(div);
      });
    });

    // auth-based enablement
    const u = auth.currentUser;
    const admin = !!(u && ADMIN_EMAILS.includes(u.email));
    [btnRefund, btnToPickup, btnToKitchen, btnForceDone].forEach(b=> b.disabled = !admin);

    dlg.showModal();
  }

  btnClose.addEventListener("click",()=>dlg.close());

  // ----- ACTIONS -----
  async function mutateOrder(id, mutator){
    const ref = db.collection("orders").doc(id);
    const snap = await ref.get();
    const o = snap.data() || {};
    const updated = mutator(structuredClone(o));
    await ref.set(updated, { merge:false }); // overwrite to ensure flags like ready are cleared
    return { before:o, after:updated };
  }

  // re-map all item ready flags
  function setItemsReady(items, ready){
    return (Array.isArray(items)?items:[]).map(it=> ({ ...it, ready: !!ready }));
  }

  // Send to Pickup (ready)
  btnToPickup.addEventListener("click", async ()=>{
    const id = btnToPickup.dataset.id; if (!id) return;
    try{
      await mutateOrder(id, (o)=>{
        const now = Date.now();
        return {
          ...o,
          status: "ready",
          archived: false,
          refunded: false,
          refundReason: null,
          refundedAt: null,
          readyAt: now,
          items: setItemsReady(o.items, true)
        };
      });
      alert("Sent to Pickup.");
      dlg.close();
    }catch(e){ console.error(e); alert("Failed. See console."); }
  });

  // Send to Kitchen (active)
  btnToKitchen.addEventListener("click", async ()=>{
    const id = btnToKitchen.dataset.id; if (!id) return;
    try{
      await mutateOrder(id, (o)=>{
        return {
          ...o,
          status: "active",
          archived: false,
          refunded: false,
          refundReason: null,
          refundedAt: null,
          items: setItemsReady(o.items, false)
        };
      });
      alert("Sent to Kitchen.");
      dlg.close();
    }catch(e){ console.error(e); alert("Failed. See console."); }
  });

  // Force Complete (Archive but still counts in Sales)
  btnForceDone.addEventListener("click", async ()=>{
    const id = btnForceDone.dataset.id; if (!id) return;
    if (!confirm("Force complete this order? It will be archived (hidden on KDS/Pickup) but still included in Sales.")) return;
    try{
      await mutateOrder(id, (o)=>{
        const now = Date.now();
        return {
          ...o,
          status: "archived",
          archived: true,
          completedAt: now,
          // keep items as-is; ensure they won't show as 'ready' anywhere
          items: setItemsReady(o.items, false)
        };
      });
      alert("Order archived.");
      dlg.close();
    }catch(e){ console.error(e); alert("Failed. See console."); }
  });

  // Refund flow: mark refunded, archive, clear any ready flags, and log to refunds
  btnRefund.addEventListener("click", async ()=>{
    const u = auth.currentUser;
    if (!u || !ADMIN_EMAILS.includes(u.email)){
      alert("You must be signed in as an admin to refund.");
      return;
    }
    const id = btnRefund.dataset.id;
    const reason = prompt("Refund reason (optional):","") || null;
    if (!confirm("Confirm full refund? Refunded orders are archived and excluded from Sales.")) return;

    const now = Date.now();
    try{
      // mutate order
      const { before, after } = await mutateOrder(id, (o)=>{
        return {
          ...o,
          status: "refunded",
          refunded: true,
          refundedAt: now,
          refundReason: reason,
          refundedBy: u.email,
          archived: true,
          // make sure nothing keeps it visible on Pickup/KDS
          readyAt: null,
          items: setItemsReady(o.items, false)
        };
      });

      // log audit copy
      await db.collection("refunds").add({
        orderId:id,
        customer:after.customer||null,
        total:Number(after.total||0),
        station:after.station||null,
        createdAt:after.createdAt||null,
        refundedAt:now,
        refundedBy:u.email,
        refundReason:reason,
        items:after.items||[]
      });

      alert("Order refunded & archived.");
      dlg.close();
    }catch(e){
      console.error(e);
      alert("Refund failed. See console.");
    }
  });

  // wire controls
  document.getElementById("apply").addEventListener("click", applyFilters);
  document.getElementById("search").addEventListener("input", applyFilters);
  document.getElementById("more").addEventListener("click", loadMore);

  // kick off
  loadFirst();
  </script>
</body>
</html>
