<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pickup Manager</title>
<style>
  :root{--bg:#ffffff;--fg:#111;--muted:#667085;--card:#f5f5f7;--border:#d7dbe2;--ok:#16a34a;--accent:#2563eb}
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;font-size:18px;line-height:1.25}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{border:1px solid var(--border);border-radius:999px;padding:8px 12px;background:#fff;color:#111;font-weight:800}
  .btn{border:none;border-radius:12px;padding:12px;cursor:pointer;font-weight:800}
  .btn.ok{background:var(--ok);color:#fff}
  .btn.gray{background:#eef2f7;color:#111}
  .btn.ac{background:var(--accent);color:#fff}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid var(--border);background:#fff;color:#111;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:800}
  .chip.active{outline:3px solid var(--ok)}
  .ticket{border:1px solid var(--border);background:#fff;border-radius:14px;padding:12px;margin-bottom:10px}
  .hdr{display:flex;justify-content:space-between;gap:10px;align-items:center}
  .customer{font-weight:900;font-size:20px}
  .colhdr{margin-top:8px;color:#334155;font-size:12px;text-transform:uppercase;letter-spacing:.04em;font-weight:900}
  .line{border-top:1px dashed var(--border);padding:6px 0}
  .mods{color:#334155;font-size:14px;margin-top:2px;font-weight:700}
  .muted{color:var(--muted);font-size:14px}
  input{font:inherit;border:1px solid var(--border);border-radius:12px;background:#fff;color:#111;padding:12px}
</style>
</head>
<body>
<div class="wrap">

  <div class="row" style="justify-content:space-between">
    <div class="row">
      <strong style="font-size:22px">Pickup Manager</strong>
      <span id="stationBadge" class="pill">Stations: loading…</span>
    </div>
    <div class="row">
      <label class="pill"><input id="sound" type="checkbox" style="margin-right:6px"> Sound on new/ready</label>
      <span id="me" class="pill">Not signed in</span>
      <button id="login" class="btn gray">Sign in</button>
      <button id="logout" class="btn gray">Sign out</button>
    </div>
  </div>

  <!-- Filters / Tools -->
  <div class="card" style="margin-top:10px">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="row" style="gap:10px;align-items:center">
        <div class="muted">Show orders with items from stations:</div>
        <div class="chips" id="chips"></div>
        <button id="selectAll" class="btn gray">Select all</button>
        <button id="savePref" class="btn ok">Save to this iPad</button>
      </div>
      <div class="row" style="gap:8px">
        <input id="searchNum" type="number" placeholder="Find order #…" style="width:180px">
        <button id="findBtn" class="btn ac">Find</button>
      </div>
    </div>
  </div>

  <!-- Orders -->
  <div class="card" style="margin-top:10px">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">Live Orders</h3>
      <label class="muted"><input id="showHistory" type="checkbox" style="margin-right:6px"> Show history (picked-up today)</label>
    </div>
    <div id="live"></div>
    <div id="emptyLive" class="muted" style="display:none">No live orders.</div>

    <div id="histBox" style="display:none;margin-top:10px">
      <h3 style="margin:0 0 6px 0">Picked Up (today)</h3>
      <div id="picked"></div>
      <div id="emptyPicked" class="muted" style="display:none">No picked orders today.</div>
    </div>
  </div>
</div>

<!-- Sound -->
<audio id="ding" preload="auto"></audio>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey:"AIzaSyBu-Ux4lvGn6-pnBngmJzL0BAtW1uIfOKM",
  authDomain:"churchfestivalpos.firebaseapp.com",
  projectId:"churchfestivalpos"
});
const db=firebase.firestore(), auth=firebase.auth();

const $=s=>document.querySelector(s);
const me=$('#me'), login=$('#login'), logout=$('#logout');
const stationBadge=$('#stationBadge'), chips=$('#chips'), selectAll=$('#selectAll'), savePref=$('#savePref');
const live=$('#live'), emptyLive=$('#emptyLive');
const histBox=$('#histBox'), showHistory=$('#showHistory'), picked=$('#picked'), emptyPicked=$('#emptyPicked');
const searchNum=$('#searchNum'), findBtn=$('#findBtn');

// ====== SOUND ======
const SOUND_URL="https://georghenin.github.io/festival-pos/mixkit-bell-notification-933.wav";
const dingEl=$('#ding'); dingEl.src=SOUND_URL;
const soundCb=$('#sound');
let lastSoundTs=Number(localStorage.getItem('pickupLastSoundTs')||'0');
function armAudioOnce(){ window.removeEventListener('click',armAudioOnce,true); try{dingEl.play().then(()=>dingEl.pause()).catch(()=>{});}catch(_){} }
window.addEventListener('click',armAudioOnce,true);
function playDing(){ if(!soundCb.checked) return; try{dingEl.currentTime=0; dingEl.play().catch(()=>{});}catch(_){} }
function newestRelevantTs(orders){
  let max=0;
  for(const o of orders){
    const t = Number(o.updatedAt||o.createdAt||0);
    if(t>max) max=t;
    for(const it of (o.items||[])){
      if(it.ready && it.readyAt && it.readyAt>max) max=it.readyAt;
    }
  }
  return max;
}

// ===== Auth =====
auth.onAuthStateChanged(u=>{ me.textContent=u?u.email:'Not signed in'; });
login.onclick=async()=>{ const e=prompt('Email:'); if(!e) return; const p=prompt('Password:'); if(p===null) return; try{await auth.signInWithEmailAndPassword(e.trim(),p);}catch(err){alert(err.message);} };
logout.onclick=()=>auth.signOut();

// ===== Stations from config =====
let STATIONS=[];
let selected=new Set(JSON.parse(localStorage.getItem('pickupStations')||'[]'));
function norm(s){ return (s||'').toString(); }

db.collection('settings').doc('config').onSnapshot(s=>{
  const conf=s.data()||{}; const arr=Array.isArray(conf.stations)?conf.stations.filter(Boolean):[];
  if(arr.length) STATIONS=arr.slice();
  if(!selected.size && STATIONS.length){ STATIONS.forEach(s=>selected.add(s)); }
  renderChips();
  stationBadge.textContent='Stations: '+(STATIONS.length?STATIONS.join(', '):'—');
});

function renderChips(){
  chips.innerHTML = (STATIONS.length
    ? STATIONS.map(s=>`<span class="chip ${selected.has(s)?'active':''}" data-st="${s}">${s}</span>`).join('')
    : `<span class="muted">No stations configured yet</span>`);
  chips.querySelectorAll('.chip').forEach(c=>{
    c.onclick=()=>{ const s=c.dataset.st; if(selected.has(s)) selected.delete(s); else selected.add(s); renderChips(); renderLists(); };
  });
}
selectAll.onclick=()=>{ STATIONS.forEach(s=>selected.add(s)); renderChips(); renderLists(); };
savePref.onclick=()=>{ localStorage.setItem('pickupStations', JSON.stringify([...selected])); alert('Saved on this iPad.'); };

// ===== Helpers =====
const itemMatchesStation = (it)=> !it.station || selected.has(norm(it.station));
const orderMatchesStations = (o)=> (o.items||[]).some(itemMatchesStation);

// ===== Data listeners (show ALL live orders automatically) =====
let unsubLive=null, unsubPicked=null;
let liveDocs=[], pickedDocs=[];

function subscribe(){
  if(unsubLive) unsubLive(); if(unsubPicked) unsubPicked();

  // Live: most recent 500 orders; client-filter out picked/refunded/archived
  unsubLive = db.collection('orders').orderBy('createdAt','desc').limit(500)
    .onSnapshot(s=>{
      liveDocs = s.docs.map(d=>({id:d.id, ...d.data()}))
        .filter(o => o.status!=='picked_up' && !o.refunded && !o.archived);
      // Ensure station discovery (if new stations appear mid-day)
      autoDiscoverStations(liveDocs);
      renderLists();
    });

  // History: picked up today
  const start=new Date(); start.setHours(0,0,0,0);
  unsubPicked = db.collection('orders')
    .where('status','==','picked_up')
    .where('updatedAt','>=', start.getTime())
    .orderBy('updatedAt','desc')
    .onSnapshot(s=>{
      pickedDocs = s.docs.map(d=>({id:d.id, ...d.data()}));
      autoDiscoverStations(pickedDocs);
      if(showHistory.checked) renderLists();
    });
}
subscribe();

function autoDiscoverStations(arr){
  const seen=new Set(STATIONS);
  arr.forEach(o => (o.items||[]).forEach(it=>{ if(it.station) seen.add(norm(it.station)); }));
  if(seen.size!==STATIONS.length){ STATIONS=[...seen]; renderChips(); stationBadge.textContent='Stations: '+STATIONS.join(', '); }
}

// ===== Render =====
function modsHTML(mods){
  const names=(mods||[]).flatMap(g=>(g.options||[]).map(o=>o.name)).filter(Boolean);
  return names.length? `<div class="mods">${names.join(', ')}</div>` : '';
}

function orderHTML(o){
  const readyItems=(o.items||[]).filter(it=> itemMatchesStation(it) && it.ready);
  const prepItems =(o.items||[]).filter(it=> itemMatchesStation(it) && !it.ready);

  const allReady = (o.items||[]).length && (o.items||[]).every(it=>it.ready);
  const btn = allReady
    ? `<button class="btn ok" data-act="picked" data-id="${o.id}">Mark Picked Up</button>`
    : `<button class="btn gray" disabled title="Whole order not ready yet">Mark Picked Up</button>`;

  return `
  <div class="ticket" data-order="${o.id}">
    <div class="hdr">
      <div>
        <div class="customer">${o.customer||'No name'} <span class="muted">#${o.number||''}</span></div>
        <div class="muted">Submitted ${new Date(o.createdAt||Date.now()).toLocaleTimeString()}</div>
      </div>
      <div>${btn}</div>
    </div>
    ${readyItems.length? `<div class="colhdr">Ready Items</div>${readyItems.map(it=>`
      <div class="line"><div><strong>${it.qty||1}× ${it.name}</strong> <span class="muted">• ${it.station||''}</span></div>${modsHTML(it.mods)}</div>`).join('')}`:''}
    ${prepItems.length? `<div class="colhdr">Still Preparing</div>${prepItems.map(it=>`
      <div class="line"><div><strong>${it.qty||1}× ${it.name}</strong> <span class="muted">• ${it.station||''}</span></div>${modsHTML(it.mods)}</div>`).join('')}`:''}
  </div>`;
}

function renderLists(){
  const list = liveDocs.filter(orderMatchesStations);
  live.innerHTML = list.map(orderHTML).join('');
  emptyLive.style.display = list.length? 'none':'block';

  // sound on new/ready
  const newest = newestRelevantTs(list);
  if(newest && newest>lastSoundTs){ playDing(); lastSoundTs=newest; localStorage.setItem('pickupLastSoundTs', String(lastSoundTs)); }

  // wire actions
  live.querySelectorAll('[data-act="picked"]').forEach(b=> b.onclick=()=> setStatus(b.dataset.id,'picked_up'));

  if(showHistory.checked){
    const p = pickedDocs.filter(orderMatchesStations);
    picked.innerHTML = p.map(o=>`
      <div class="ticket">
        <div class="hdr">
          <div>
            <div class="customer">${o.customer||'No name'} <span class="muted">#${o.number||''}</span></div>
            <div class="muted">${new Date(o.updatedAt||o.createdAt||Date.now()).toLocaleTimeString()}</div>
          </div>
          <div><button class="btn gray" data-act="undo" data-id="${o.id}">Undo</button></div>
        </div>
        ${(o.items||[]).filter(itemMatchesStation).map(it=>`
          <div class="line"><div><strong>${it.qty||1}× ${it.name}</strong> <span class="muted">• ${it.station||''}</span></div>${modsHTML(it.mods)}</div>
        `).join('')}
      </div>`).join('');
    emptyPicked.style.display = p.length? 'none':'block';
    picked.querySelectorAll('[data-act="undo"]').forEach(b=> b.onclick=()=> setStatus(b.dataset.id,'ready'));
  }else{
    histBox.style.display='none';
  }
}
showHistory.onchange=()=>{ histBox.style.display = showHistory.checked? 'block':'none'; renderLists(); };

// ===== Actions =====
async function setStatus(id, status){
  try{ await db.collection('orders').doc(id).update({status, updatedAt: Date.now()}); }
  catch(e){ alert(e.message); }
}

// ===== Order number search =====
function scrollToOrder(orderId){
  const el = live.querySelector(`[data-order="${orderId}"]`);
  if(el){ el.scrollIntoView({behavior:'smooth',block:'center'}); el.style.outline='3px solid #2563eb'; setTimeout(()=> el.style.outline='none', 1500); }
}
findBtn.onclick = async ()=>{
  const n = Number(searchNum.value||'');
  if(!Number.isFinite(n)) return;
  // first try to find in current list
  const inList = liveDocs.find(o=>Number(o.number)===n);
  if(inList){ scrollToOrder(inList.id); return; }
  // minimal fetch by number (if indexed)
  try{
    const q=await db.collection('orders').where('number','==', n).limit(1).get();
    if(!q.empty){
      const doc=q.docs[0]; const o={id:doc.id, ...doc.data()};
      // render a temporary card at the top so you can see it even if station filters would hide it
      live.insertAdjacentHTML('afterbegin', orderHTML(o));
      scrollToOrder(o.id);
    }else{
      alert('Order not found.');
    }
  }catch(e){
    alert('Search error: '+e.message);
  }
};
searchNum.addEventListener('keydown', (e)=>{ if(e.key==='Enter') findBtn.click(); });
</script>
</body></html>
