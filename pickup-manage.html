<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pickup Manager</title>
<style>
  :root{--bg:#0d0f13;--fg:#f5f7fa;--muted:#95a0ad;--card:#0f141e;--border:#1b2230;--ok:#2fd28f;--accent:#5b9bff}
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;color:#aab3c0;background:#0f1420}
  .btn{border:none;border-radius:10px;padding:10px 12px;cursor:pointer;color:#fff;background:var(--accent)}
  .btn.ok{background:var(--ok);color:#0b0e14}.btn.gray{background:#1e2432}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid var(--border);background:#0f1420;color:#e5e8ee;border-radius:999px;padding:6px 10px;cursor:pointer}
  .chip.active{outline:2px solid var(--ok)}
  .ticket{border:1px solid var(--border);background:#121826;border-radius:14px;padding:10px;margin-bottom:10px}
  .hdr{display:flex;justify-content:space-between;gap:10px;align-items:center}
  .customer{font-weight:800}
  .line{border-top:1px dashed #293246;padding:6px 0}
  .mods{color:#aeb7c6;font-size:12px;margin-top:2px}
  .muted{color:var(--muted);font-size:12px}
  .history{margin-top:10px;display:none}
</style>
</head>
<body>
<div class="wrap">

  <div class="row" style="justify-content:space-between">
    <div class="row">
      <strong style="font-size:20px">Pickup Manager</strong>
      <span id="stationBadge" class="pill">Stations: loading…</span>
    </div>
    <div class="row">
      <label class="pill"><input id="sound" type="checkbox" style="margin-right:6px"> Sound on new ready</label>
      <span id="me" class="pill">Not signed in</span>
      <button id="login" class="btn">Sign in</button>
      <button id="logout" class="btn gray">Sign out</button>
    </div>
  </div>

  <!-- Station filters -->
  <div class="card" style="margin-top:10px">
    <div class="row" style="justify-content:space-between">
      <div>
        <div class="muted" style="margin-bottom:6px">Only show orders that contain items from these stations:</div>
        <div class="chips" id="chips"></div>
      </div>
      <div class="row">
        <button id="selectAll" class="btn gray">Select all</button>
        <button id="savePref" class="btn ok">Save to this iPad</button>
      </div>
    </div>
  </div>

  <!-- Ready list -->
  <div class="card" style="margin-top:10px">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">Ready for Pickup</h3>
      <button id="toggleHist" class="btn gray">Show history</button>
    </div>
    <div id="ready"></div>
    <div id="emptyReady" class="muted" style="display:none">No ready orders.</div>

    <!-- History (picked) -->
    <div id="hist" class="history">
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <h3 style="margin:0">Picked Up (today)</h3>
        <button id="showAll" class="btn gray">Show all history</button>
      </div>
      <div id="picked"></div>
      <div id="emptyPicked" class="muted" style="display:none">No picked orders.</div>
    </div>
  </div>

</div>

<audio id="ding"><source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA..." type="audio/mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey:"AIzaSyBu-Ux4lvGn6-pnBngmJzL0BAtW1uIfOKM",
  authDomain:"churchfestivalpos.firebaseapp.com",
  projectId:"churchfestivalpos"
});
const db=firebase.firestore(), auth=firebase.auth();

const $=s=>document.querySelector(s);
const me=$('#me'), login=$('#login'), logout=$('#logout');
const stationBadge=$('#stationBadge'), chips=$('#chips'), selectAll=$('#selectAll'), savePref=$('#savePref');
const ready=$('#ready'), picked=$('#picked'), emptyReady=$('#emptyReady'), emptyPicked=$('#emptyPicked');
const sound=$('#sound'), ding=$('#ding'), toggleHist=$('#toggleHist'), histBox=$('#hist'), showAll=$('#showAll');

let STATIONS=['Grill','Fryer','Drinks','Pizza'];
let selected=new Set(JSON.parse(localStorage.getItem('pickupStations')||'[]'));
let lastReadySeen=0;
let showAllHistory=false;

auth.onAuthStateChanged(u=>{ me.textContent=u?u.email:'Not signed in'; });
login.onclick=async()=>{ const e=prompt('Email:'); if(!e) return; const p=prompt('Password:'); if(p===null) return; try{await auth.signInWithEmailAndPassword(e.trim(),p);}catch(err){alert(err.message);} };
logout.onclick=()=>auth.signOut();

async function loadStations(){
  try{
    const s=await db.collection('settings').doc('config').get();
    const conf=s.data(); if(conf && Array.isArray(conf.stations) && conf.stations.length) STATIONS=conf.stations;
  }catch(e){}
  renderChips(); stationBadge.textContent='Stations: '+STATIONS.join(', ');
}
function renderChips(){
  if(!selected.size){ STATIONS.forEach(s=>selected.add(s)); }
  chips.innerHTML = STATIONS.map(s=>`<span class="chip ${selected.has(s)?'active':''}" data-st="${s}">${s}</span>`).join('');
  chips.querySelectorAll('.chip').forEach(c=>{
    c.onclick=()=>{ const s=c.dataset.st; if(selected.has(s)) selected.delete(s); else selected.add(s); renderChips(); renderLists(); };
  });
}
selectAll.onclick=()=>{ selected=new Set(STATIONS); renderChips(); renderLists(); };
savePref.onclick=()=>{ localStorage.setItem('pickupStations', JSON.stringify([...selected])); alert('Saved on this iPad.'); };

let unsubReady=null, unsubPicked=null;
let readyDocs=[], pickedDocs=[];
function subscribe(){
  if(unsubReady) unsubReady(); if(unsubPicked) unsubPicked();
  unsubReady = db.collection('orders').where('status','==','ready').orderBy('updatedAt','desc').limit(300)
    .onSnapshot(s=>{ readyDocs=s.docs.map(d=>({id:d.id,...d.data()})); renderLists(true); });
  const start=new Date(); start.setHours(0,0,0,0);
  unsubPicked = db.collection('orders')
    .where('status','==','picked').where('updatedAt','>=',start.getTime())
    .orderBy('updatedAt','desc').limit(200)
    .onSnapshot(s=>{ pickedDocs=s.docs.map(d=>({id:d.id,...d.data()})); if(histBox.style.display!=='none') renderLists(); });
}
toggleHist.onclick=()=>{
  const open = histBox.style.display!=='none';
  histBox.style.display = open ? 'none' : 'block';
  toggleHist.textContent = open ? 'Show history' : 'Hide history';
  if(!open) renderLists();
};
showAll.onclick=()=>{
  showAllHistory=!showAllHistory; showAll.textContent=showAllHistory?'Show today only':'Show all history';
  if(unsubPicked) unsubPicked();
  if(showAllHistory){
    unsubPicked = db.collection('orders').where('status','==','picked').orderBy('updatedAt','desc').limit(400)
      .onSnapshot(s=>{ pickedDocs=s.docs.map(d=>({id:d.id,...d.data()})); if(histBox.style.display!=='none') renderLists(); });
  }else{
    const start=new Date(); start.setHours(0,0,0,0);
    unsubPicked = db.collection('orders').where('status','==','picked').where('updatedAt','>=',start.getTime())
      .orderBy('updatedAt','desc').limit(200)
      .onSnapshot(s=>{ pickedDocs=s.docs.map(d=>({id:d.id,...d.data()})); if(histBox.style.display!=='none') renderLists(); });
  }
};

function itemMatchesStations(it){ return !it.station || selected.has(it.station); }
function orderHasSelectedStations(o){ return (o.items||[]).some(itemMatchesStations); }

function modsHTML(mods){
  if(!mods || !mods.length) return '';
  const names = mods.flatMap(g => (g.options||[]).map(o=>o.name)).filter(Boolean);
  if(!names.length) return '';
  return `<div class="mods">${names.join(', ')}</div>`;
}
function orderHTML(o, mode){
  const lines=(o.items||[]).filter(itemMatchesStations).map(it=>`
    <div class="line">
      <div><strong>${it.qty||1}× ${it.name||''}</strong> <span class="muted">• ${it.station||''}</span></div>
      ${modsHTML(it.mods)}
    </div>
  `).join('');
  const btn = mode==='ready'
    ? `<button class="btn ok" data-act="picked" data-id="${o.id}">Mark Picked Up</button>`
    : `<button class="btn gray" data-act="undo" data-id="${o.id}">Undo</button>`;
  return `
  <div class="ticket">
    <div class="hdr">
      <div>
        <div class="customer">${o.customer||'No name'} <span class="muted">#${o.number||''}</span></div>
        <div class="muted">${new Date((o.updatedAt||o.createdAt)||Date.now()).toLocaleTimeString()}</div>
      </div>
      <div>${btn}</div>
    </div>
    ${lines||'<div class="muted" style="margin-top:6px">No items for selected stations.</div>'}
  </div>`;
}

function renderLists(maybeSound){
  const r=readyDocs.filter(orderHasSelectedStations);
  ready.innerHTML = r.map(o=>orderHTML(o,'ready')).join('');
  emptyReady.style.display = r.length? 'none':'block';

  if(maybeSound && sound.checked && r.length){
    const newest=r[0]?.updatedAt || r[0]?.createdAt || 0;
    if(newest>lastReadySeen){ lastReadySeen=newest; try{ding.currentTime=0;ding.play();}catch(ex){} }
  }

  if(histBox.style.display!=='none'){
    const p=pickedDocs.filter(orderHasSelectedStations);
    picked.innerHTML = p.map(o=>orderHTML(o,'picked')).join('');
    emptyPicked.style.display = p.length? 'none':'block';
    picked.querySelectorAll('[data-act="undo"]').forEach(b=>{
      b.onclick=()=> setStatus(b.dataset.id,'ready');
    });
  }

  ready.querySelectorAll('[data-act="picked"]').forEach(b=>{
    b.onclick=()=> setStatus(b.dataset.id,'picked');
  });
}

async function setStatus(id, status){
  try{ await db.collection('orders').doc(id).update({status, updatedAt: Date.now()}); }
  catch(e){ alert(e.message); }
}

// init
loadStations(); subscribe();
</script>
</body></html>
