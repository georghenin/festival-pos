<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Back Office — Sales & Analytics</title>
<style>
  :root{
    --bg:#ffffff; --fg:#111; --muted:#666;
    --card:#f5f5f7; --border:#d7dbe2;
    --accent:#2563eb; --ok:#15a46b; --warn:#d97706;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;font-size:18px;line-height:1.25}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .pill{border:1px solid var(--border);border-radius:999px;padding:8px 12px;background:#fff;color:#111;font-weight:700}
  .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px}
  .btn{border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#fff;color:#111;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:transparent;color:#fff}
  .btn.ok{background:var(--ok);border-color:transparent;color:#fff}
  .btn.gray{background:#eef2f7}
  input,select{font:inherit;border:1px solid var(--border);border-radius:12px;background:#fff;color:#111;padding:10px 12px}
  h2{margin:0 0 8px 0;font-size:22px}
  h3{margin:0 0 8px 0;font-size:20px}

  .chips{display:flex;gap:10px;flex-wrap:wrap}
  .chip{border:1px solid var(--border);background:#fff;color:#111;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:700}
  .chip.active{outline:3px solid var(--ok)}

  .toolbar{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:end}
  .filters{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .filters .wide{grid-column:span 2}
  @media (max-width:900px){ .filters{grid-template-columns:1fr 1fr} }

  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{border:1px solid var(--border);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer;font-weight:800}
  .tab.active{outline:3px solid var(--accent);color:#0b1f52}

  .totals{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .total-card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px;text-align:center}
  .total-val{font-size:22px;font-weight:900}
  .total-lbl{color:var(--muted);font-size:14px}

  .selbar{background:#fff;border:2px solid var(--accent);border-radius:14px;padding:10px;margin-top:10px;display:none}
  .selbar strong{font-size:18px}

  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:10px;text-align:left;vertical-align:top}
  th{background:#fff;position:sticky;top:0;z-index:2}
  .num{text-align:right}
  .muted{color:var(--muted)}
  .expander{cursor:pointer;color:#0b1f52;font-weight:700}

  .charts{display:grid;grid-template-columns:1fr;gap:12px}
  canvas{background:#fff;border:1px solid var(--border);border-radius:14px;padding:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between">
    <h2>Back Office — Sales & Analytics</h2>
    <div class="row">
      <span id="stationsBadge" class="pill">Stations: loading…</span>
    </div>
  </div>

  <!-- Filters -->
  <div class="card" style="margin-top:12px">
    <div class="filters">
      <div>
        <div class="muted" style="margin-bottom:4px">Start date</div>
        <input type="date" id="startDate">
      </div>
      <div>
        <div class="muted" style="margin-bottom:4px">End date</div>
        <input type="date" id="endDate">
      </div>
      <div>
        <div class="muted" style="margin-bottom:4px">Group by</div>
        <div class="tabs">
          <button class="tab active" data-mode="items" id="tabItems">Items</button>
          <button class="tab" data-mode="stations" id="tabStations">Stations</button>
        </div>
      </div>
      <div class="wide" id="itemSearchWrap">
        <div class="muted" style="margin-bottom:4px">Search items</div>
        <input id="itemSearch" placeholder="Type to filter items by name…">
      </div>
    </div>

    <div class="muted" style="margin:10px 0 6px 0">Filter by stations</div>
    <div id="stationChips" class="chips"></div>

    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button id="refresh" class="btn primary">Run Report</button>
      <button id="exportCsv" class="btn">Export CSV (All)</button>
      <button id="exportCsvSel" class="btn" style="display:none">Export CSV (Selected)</button>
    </div>
  </div>

  <!-- Totals -->
  <div class="totals" style="margin-top:12px">
    <div class="total-card">
      <div class="total-val" id="tRevenue">$0.00</div>
      <div class="total-lbl">Revenue (filtered)</div>
    </div>
    <div class="total-card">
      <div class="total-val" id="tItems">0</div>
      <div class="total-lbl">Items sold (filtered)</div>
    </div>
    <div class="total-card">
      <div class="total-val" id="tOrders">0</div>
      <div class="total-lbl">Orders counted (filtered)</div>
    </div>
  </div>

  <!-- Selected totals bar (appears when rows are checked) -->
  <div id="selBar" class="selbar">
    <div class="row" style="justify-content:space-between">
      <div><strong>Selected Totals:</strong>
        <span id="selRevenue" style="margin-left:12px">$0.00</span> •
        <span id="selItems">0 items</span>
      </div>
      <button id="clearSelection" class="btn gray">Clear selection</button>
    </div>
  </div>

  <!-- Table -->
  <div class="card" style="margin-top:12px">
    <h3 id="tableTitle" style="margin-bottom:8px">Sales by Items</h3>
    <div style="max-height:420px;overflow:auto;border-radius:12px">
      <table id="dataTable">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts" style="margin-top:12px">
    <div>
      <h3 style="margin-bottom:6px">Daily Revenue</h3>
      <canvas id="chartDaily" width="900" height="260"></canvas>
    </div>
    <div id="stationChartWrap" style="display:none">
      <h3 style="margin-bottom:6px">Revenue by Station</h3>
      <canvas id="chartStations" width="900" height="260"></canvas>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey:"AIzaSyBu-Ux4lvGn6-pnBngmJzL0BAtW1uIfOKM",
  authDomain:"churchfestivalpos.firebaseapp.com",
  projectId:"churchfestivalpos"
});
const db=firebase.firestore();

/* ---------- DOM ---------- */
const $=s=>document.querySelector(s);
const stationsBadge=$('#stationsBadge');
const startDate=$('#startDate'), endDate=$('#endDate');
const tabItems=$('#tabItems'), tabStations=$('#tabStations');
const itemSearchWrap=$('#itemSearchWrap'), itemSearch=$('#itemSearch');
const stationChips=$('#stationChips');
const refreshBtn=$('#refresh'), exportCsv=$('#exportCsv'), exportCsvSel=$('#exportCsvSel');
const tRevenue=$('#tRevenue'), tItems=$('#tItems'), tOrders=$('#tOrders');
const selBar=$('#selBar'), selRevenue=$('#selRevenue'), selItems=$('#selItems'), clearSelection=$('#clearSelection');
const tableTitle=$('#tableTitle'), thead=$('#thead'), tbody=$('#tbody');
const chartDaily=$('#chartDaily'), chartStations=$('#chartStations'), stationChartWrap=$('#stationChartWrap');

/* ---------- State ---------- */
let MODE='items'; // 'items' | 'stations'
let STATIONS_ALL=['Grill','Fryer','Drinks','Pizza'];
let selectedStations=new Set();
let orders=[];  // filtered source orders
let aggItems=[], aggStations=[], dailySeries=[];
let rowSelection=new Set(); // ids of selected rows

/* ---------- Init dates (today) ---------- */
(function initDates(){
  const d=new Date(); const endISO=d.toISOString().slice(0,10);
  const d2=new Date(); d2.setDate(d2.getDate()-0);
  const startISO=d2.toISOString().slice(0,10);
  startDate.value=startISO; endDate.value=endISO;
})();

/* ---------- Stations from settings ---------- */
async function loadStations(){
  try{
    const s=await db.collection('settings').doc('config').get();
    const conf=s.data(); if(conf && Array.isArray(conf.stations) && conf.stations.length) STATIONS_ALL=conf.stations;
  }catch(e){}
  stationsBadge.textContent='Stations: '+STATIONS_ALL.join(', ');
  if(!selectedStations.size) STATIONS_ALL.forEach(s=>selectedStations.add(s));
  renderStationChips();
}

function renderStationChips(){
  stationChips.innerHTML=STATIONS_ALL.map(s=>`<span class="chip ${selectedStations.has(s)?'active':''}" data-st="${s}">${s}</span>`).join('');
  stationChips.querySelectorAll('.chip').forEach(c=>{
    c.onclick=()=>{ const s=c.dataset.st; selectedStations.has(s)?selectedStations.delete(s):selectedStations.add(s); renderStationChips(); };
  });
}

/* ---------- Tabs ---------- */
function setMode(m){
  MODE=m;
  tabItems.classList.toggle('active', m==='items');
  tabStations.classList.toggle('active', m==='stations');
  itemSearchWrap.style.display = (m==='items') ? 'block' : 'none';
  tableTitle.textContent = m==='items' ? 'Sales by Items' : 'Sales by Stations';
  stationChartWrap.style.display = (m==='stations') ? 'block' : 'none';
  renderTable(); renderSelectedBar();
}
tabItems.onclick=()=> setMode('items');
tabStations.onclick=()=> setMode('stations');

/* ---------- Fetch + Aggregate ---------- */
refreshBtn.onclick=runReport;
async function runReport(){
  rowSelection.clear();
  renderSelectedBar();

  const startMS = new Date(startDate.value+'T00:00:00').getTime();
  const endMS   = new Date(endDate.value+'T23:59:59').getTime();

  // Query by createdAt within range (one-off read)
  const snap=await db.collection('orders')
    .where('createdAt','>=', startMS)
    .where('createdAt','<=', endMS)
    .orderBy('createdAt','asc')
    .get();

  // Keep only completed sales
  const base = snap.docs.map(d=>({id:d.id, ...d.data()}))
    .filter(o=> (o.status==='picked_up' || o.status==='force_completed') && !o.refunded && !o.archived);

  // Apply station filter at item level
  const stAllowed=new Set(selectedStations);
  orders = base.map(o=>{
    const items=(o.items||[]).filter(it=> !it.station || stAllowed.has(it.station));
    return {...o, items};
  }).filter(o=> (o.items||[]).length>0);

  aggregate();
  renderTotals();
  renderTable();
  drawDailyChart();
  if(MODE==='stations') drawStationChart();
}

function aggregate(){
  // Items
  const byItem=new Map();
  // Stations
  const byStation=new Map();
  // Daily revenue
  const byDay=new Map();

  orders.forEach(o=>{
    const day = new Date(o.createdAt||o.updatedAt||0);
    day.setHours(0,0,0,0);
    const dayKey=day.getTime();

    let orderRevenue=0, orderItems=0;

    (o.items||[]).forEach(it=>{
      const qty = Number(it.qty||1);
      const unit = Number(it.price||0);
      const lineRev = round2(qty*unit);
      orderRevenue += lineRev;
      orderItems += qty;

      const ikey = (it.name||'Unknown') + '|' + (it.station||'');
      const curI = byItem.get(ikey) || { key:ikey, name:it.name||'Unknown', station:it.station||'', qty:0, revenue:0, lines:[], mods:{} };
      curI.qty += qty; curI.revenue = round2(curI.revenue + lineRev);
      // capture modifiers
      (it.mods||[]).forEach(g=>{
        (g.options||[]).forEach(opt=>{
          const mk = g.groupName+'|'+opt.name;
          curI.mods[mk] = (curI.mods[mk]||{group:g.groupName, option:opt.name, qty:0, revenue:0});
          curI.mods[mk].qty += qty;
          curI.mods[mk].revenue = round2(curI.mods[mk].revenue + (qty*Number(opt.price||0)));
        });
      });
      byItem.set(ikey, curI);

      const sKey = it.station||'';
      const curS = byStation.get(sKey) || { station:sKey, orders:0, items:0, revenue:0, _orderSet:new Set() };
      curS.items += qty;
      curS.revenue = round2(curS.revenue + lineRev);
      curS._orderSet.add(o.id);
      byStation.set(sKey, curS);
    });

    byDay.set(dayKey, round2((byDay.get(dayKey)||0) + orderRevenue));
  });

  // finalize station order counts
  byStation.forEach(v => v.orders = v._orderSet.size);

  aggItems = Array.from(byItem.values()).map(v=>({ 
    id:v.key, name:v.name, station:v.station, qty:v.qty, revenue:v.revenue, avg: v.qty? round2(v.revenue/v.qty):0, mods:v.mods 
  }));

  aggStations = Array.from(byStation.values()).map(v=>({
    id:v.station||'(no station)', station:v.station||'(no station)', orders:v.orders, items:v.items, revenue:v.revenue
  }));

  // daily series to array sorted by day
  dailySeries = Array.from(byDay.entries()).sort((a,b)=>a[0]-b[0]).map(([k,v])=>({day:new Date(Number(k)), revenue:v}));
}

function renderTotals(){
  const revenue = orders.reduce((a,o)=> a + (o.items||[]).reduce((s,it)=> s + Number(it.qty||1)*Number(it.price||0), 0), 0);
  const items   = orders.reduce((a,o)=> a + (o.items||[]).reduce((s,it)=> s + Number(it.qty||1), 0), 0);
  const orderCt = orders.length;

  tRevenue.textContent = fmt$ (revenue);
  tItems.textContent   = items.toString();
  tOrders.textContent  = orderCt.toString();
}

/* ---------- Table rendering ---------- */
function renderTable(){
  rowSelection.clear();
  renderSelectedBar();

  if(MODE==='items'){
    // apply item search
    const q=(itemSearch.value||'').trim().toLowerCase();
    const rows = q ? aggItems.filter(r => (r.name||'').toLowerCase().includes(q)) : aggItems.slice();

    thead.innerHTML = `
      <tr>
        <th style="width:44px"><input type="checkbox" id="selAll"></th>
        <th>Item</th>
        <th>Station</th>
        <th class="num">Qty</th>
        <th class="num">Revenue</th>
        <th class="num">Avg Price</th>
        <th>Modifiers</th>
      </tr>`;
    tbody.innerHTML = rows.map(r=>`
      <tr data-id="${esc(r.id)}">
        <td><input type="checkbox" class="sel"></td>
        <td><strong>${esc(r.name)}</strong></td>
        <td>${esc(r.station||'')}</td>
        <td class="num">${r.qty}</td>
        <td class="num">${fmt$(r.revenue)}</td>
        <td class="num">${fmt$(r.avg)}</td>
        <td>${modsSummaryHTML(r.mods)}</td>
      </tr>
    `).join('');

    wireSelection();
  }else{
    // stations mode
    const rows=aggStations.slice();

    thead.innerHTML = `
      <tr>
        <th style="width:44px"><input type="checkbox" id="selAll"></th>
        <th>Station</th>
        <th class="num">Orders</th>
        <th class="num">Items Sold</th>
        <th class="num">Revenue</th>
      </tr>`;
    tbody.innerHTML = rows.map(r=>`
      <tr data-id="${esc(r.id)}">
        <td><input type="checkbox" class="sel"></td>
        <td><strong>${esc(r.station)}</strong></td>
        <td class="num">${r.orders}</td>
        <td class="num">${r.items}</td>
        <td class="num">${fmt$(r.revenue)}</td>
      </tr>
    `).join('');

    wireSelection();
  }
}

itemSearch.oninput = ()=> renderTable();

function wireSelection(){
  const selAll=$('#selAll');
  const boxes=[...tbody.querySelectorAll('input.sel')];
  selAll.onclick=()=>{ boxes.forEach(b=>{ b.checked=selAll.checked; toggleRow(b.closest('tr').dataset.id, b.checked); }); renderSelectedBar(); };
  boxes.forEach(b=>{
    b.onchange=()=>{ toggleRow(b.closest('tr').dataset.id, b.checked); renderSelectedBar(); };
  });
}

function toggleRow(id, checked){
  if(checked) rowSelection.add(id); else rowSelection.delete(id);
}

function renderSelectedBar(){
  if(rowSelection.size===0){
    selBar.style.display='none';
    exportCsvSel.style.display='none';
    return;
  }
  exportCsvSel.style.display='inline-block';

  let items=0, revenue=0;
  if(MODE==='items'){
    aggItems.forEach(r=>{
      if(rowSelection.has(r.id)){ items += r.qty; revenue += r.revenue; }
    });
  }else{
    aggStations.forEach(r=>{
      if(rowSelection.has(r.id)){ items += r.items; revenue += r.revenue; }
    });
  }
  selRevenue.textContent = fmt$(revenue);
  selItems.textContent   = MODE==='items' ? `${items} items` : `${items} items`;
  selBar.style.display='block';
}
clearSelection.onclick=()=>{ rowSelection.clear(); [...tbody.querySelectorAll('input.sel')].forEach(b=> b.checked=false); renderSelectedBar(); };

/* ---------- Charts (vanilla canvas) ---------- */
function drawDailyChart(){
  const ctx=chartDaily.getContext('2d');
  ctx.clearRect(0,0,chartDaily.width,chartDaily.height);

  const W=chartDaily.width, H=chartDaily.height, P=28;
  // axes
  ctx.strokeStyle='#cbd5e1'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(P,H-P); ctx.lineTo(W-P,H-P); ctx.lineTo(W-P,P); ctx.stroke();

  if(!dailySeries.length) return;

  const xs=dailySeries.map(d=>d.day.getTime());
  const ys=dailySeries.map(d=>d.revenue);
  const xmin = Math.min(...xs), xmax=Math.max(...xs);
  const ymin = 0, ymax=Math.max(...ys)*1.1 || 1;

  const xscale=t=> P + ( (t-xmin)/(xmax-xmin||1) )*(W-2*P);
  const yscale=v=> (H-P) - ( (v-ymin)/(ymax-ymin||1) )*(H-2*P);

  // grid + labels
  ctx.fillStyle='#0f172a'; ctx.font='14px system-ui';
  const steps=Math.min(10, dailySeries.length);
  for(let i=0;i<=steps;i++){
    const t=xmin + (i/steps)*(xmax-xmin);
    const x=xscale(t);
    ctx.strokeStyle='#e2e8f0'; ctx.beginPath(); ctx.moveTo(x,H-P); ctx.lineTo(x,P); ctx.stroke();
    const d=new Date(t);
    ctx.fillText((d.getMonth()+1)+'/'+d.getDate(), x-16, H-6);
  }

  // line
  ctx.strokeStyle='#1f6feb'; ctx.lineWidth=2;
  ctx.beginPath();
  dailySeries.forEach((pt,i)=>{ const x=xscale(pt.day.getTime()); const y=yscale(pt.revenue); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.stroke();

  // dots
  ctx.fillStyle='#1f6feb';
  dailySeries.forEach(pt=>{ const x=xscale(pt.day.getTime()); const y=yscale(pt.revenue); ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill(); });
}

function drawStationChart(){
  const ctx=chartStations.getContext('2d');
  ctx.clearRect(0,0,chartStations.width,chartStations.height);
  const W=chartStations.width, H=chartStations.height, P=28;

  const data=aggStations.slice().sort((a,b)=>b.revenue-a.revenue);
  if(!data.length) return;

  const ymax = Math.max(...data.map(x=>x.revenue))*1.1 || 1;
  const barW = Math.max(24, (W-2*P)/Math.max(1,data.length) - 10);

  // axes
  ctx.strokeStyle='#cbd5e1'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(P,H-P); ctx.lineTo(W-P,H-P); ctx.lineTo(W-P,P); ctx.stroke();

  // bars
  ctx.fillStyle='#2563eb';
  data.forEach((r,i)=>{
    const x = P + i*(barW+10);
    const bh = Math.round(((r.revenue)/(ymax))* (H-2*P));
    const y = (H-P) - bh;
    ctx.fillRect(x,y,barW,bh);
    ctx.fillStyle='#0f172a'; ctx.font='13px system-ui';
    ctx.fillText(r.station||'(no station)', x, H-6);
    ctx.fillStyle='#2563eb';
  });
}

/* ---------- CSV Export ---------- */
exportCsv.onclick=()=> exportCurrent(false);
exportCsvSel.onclick=()=> exportCurrent(true);

function exportCurrent(onlySelected){
  let rows=[], headers=[];
  if(MODE==='items'){
    const data = onlySelected ? aggItems.filter(r=>rowSelection.has(r.id)) : aggItems;
    headers=['Item','Station','Qty','Revenue','Avg Price'];
    rows = data.map(r=> [r.name, r.station||'', r.qty, r.revenue.toFixed(2), r.avg.toFixed(2)]);
  }else{
    const data = onlySelected ? aggStations.filter(r=>rowSelection.has(r.id)) : aggStations;
    headers=['Station','Orders','Items Sold','Revenue'];
    rows = data.map(r=> [r.station, r.orders, r.items, r.revenue.toFixed(2)]);
  }
  const csv = [headers.join(','), ...rows.map(r=>r.map(csvEsc).join(','))].join('\n');
  const blob=new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download = MODE==='items' ? 'sales_by_items.csv' : 'sales_by_stations.csv';
  document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
}

/* ---------- Helpers ---------- */
function round2(n){ return Math.round((+n||0)*100)/100; }
function fmt$(n){ return '$'+(round2(n)).toFixed(2); }
function esc(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function csvEsc(x){ const s=String(x??''); return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }

/* ---------- Boot ---------- */
loadStations();
setMode('items');
</script>
</body>
</html>
