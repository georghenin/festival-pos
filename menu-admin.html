<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Menu Admin</title>
<style>
  :root{--bg:#0d0f13;--fg:#f5f7fa;--muted:#95a0ad;--accent:#5b9bff;--ok:#2fd28f;--warn:#ffb020;--danger:#ff6b6b;--card:#0f141e;--border:#1b2230}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .space{height:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
  .btn{border:none;border-radius:12px;padding:10px 12px;color:#fff;background:var(--accent);font:inherit;cursor:pointer}
  .btn.ok{background:var(--ok)} .btn.warn{background:var(--warn)} .btn.danger{background:var(--danger)} .btn.gray{background:#1e2432;color:#e5e8ee}
  input,select{font:inherit;background:#121826;color:#eaf0f6;border:1px solid var(--border);border-radius:10px;padding:10px 12px}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0f1420;color:#95a0ad;font-size:12px}
  .hidden{display:none!important}
  table{width:100%;border-collapse:collapse}
  td,th{border-bottom:1px solid var(--border);padding:8px;text-align:left;vertical-align:middle}
  .small{font-size:12px;color:var(--muted)}
  .right{display:flex;gap:8px;justify-content:flex-end}
  .w120{width:120px}.w160{width:160px}.w220{width:220px}
  .center{text-align:center}
  .search{flex:1;min-width:200px}
  .thumb{width:44px;height:44px;border-radius:8px;object-fit:cover;background:#0b101a;border:1px solid var(--border)}
</style>
</head>
<body>
<div class="container">
  <div class="row" style="justify-content:space-between">
    <h2 class="title">Menu Admin</h2>
    <div class="row">
      <span class="pill" id="me">Not signed in</span>
      <button id="signout" class="btn gray hidden">Sign out</button>
    </div>
  </div>

  <!-- Auth -->
  <div id="auth" class="card">
    <div class="row">
      <input id="email" type="email" placeholder="Admin email" class="w160">
      <input id="pass" type="password" placeholder="Password" class="w160">
      <button id="login" class="btn">Sign in</button>
      <button id="create" class="btn gray" title="Admins only">Create user</button>
    </div>
    <div id="msg" class="small" style="margin-top:8px"></div>
  </div>

  <!-- App -->
  <div id="app" class="hidden">
    <!-- Add new item -->
    <div class="card">
      <div class="row">
        <input id="name" placeholder="Item name" style="flex:2">
        <input id="price" type="number" step="0.01" placeholder="Price" class="w120">
        <!-- dynamically populated -->
        <select id="station" class="w160"></select>
        <input id="img" placeholder="Image URL (optional)" class="w220">
        <label class="row" style="gap:6px"><input id="active" type="checkbox" checked> Active</label>
        <button id="add" class="btn ok" title="Admins only">Add</button>
        <input id="search" class="search" placeholder="Search name/station…">
      </div>
      <div class="small" style="margin-top:6px">
        Items show in the POS alphabetically by <b>Name</b>. Image should be a small thumbnail (≈200–300px wide).
      </div>
    </div>

    <div class="space"></div>

    <!-- Table -->
    <div class="card">
      <table id="table">
        <thead>
          <tr>
            <th>Pic</th>
            <th>Name</th>
            <th>Price</th>
            <th>Station</th>
            <th class="center">Active</th>
            <th class="right">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="empty" class="small" style="margin-top:8px;display:none">No items match your search.</div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>

<script>
// ---- Firebase config (your project) ----
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBu-Ux4lvGn6-pnBngmJzL0BAtW1uIfOKM",
  authDomain: "churchfestivalpos.firebaseapp.com",
  projectId: "churchfestivalpos",
  storageBucket: "churchfestivalpos.firebasestorage.app",
  messagingSenderId: "447909610900",
  appId: "1:447909610900:web:a54a828bacfa02e7883b81"
};

// Admins (lowercase for safety)
const ADMIN_EMAILS = ["smsmofri@gmail.com","george.henin98@gmail.com"];
const ADMIN_SET = new Set(ADMIN_EMAILS.map(e => e.toLowerCase()));

// DOM
const $ = s => document.querySelector(s);
const authBox = $('#auth'), appBox = $('#app'), me = $('#me'), signout = $('#signout'), msg = $('#msg');
const email = $('#email'), pass = $('#pass'), login = $('#login'), create = $('#create');
const nameEl = $('#name'), priceEl = $('#price'), stationEl = $('#station'), imgEl = $('#img'), activeEl = $('#active'), addBtn = $('#add');
const tableBody = document.querySelector('#table tbody');
const search = $('#search'), empty = $('#empty');

firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.firestore();
const auth = firebase.auth();

let IS_ADMIN = false;
let STATIONS_ALL = ['Grill','Fryer','Drinks','Pizza']; // fallback
let ALL = [];   // all menu items from Firestore
let VIEW = [];  // filtered view

function computeIsAdmin(u){
  return !!(u && u.email) && ADMIN_SET.has(String(u.email).toLowerCase());
}
function setUI(user){
  IS_ADMIN = computeIsAdmin(user);
  const on = !!user;
  authBox.classList.toggle('hidden', on);
  appBox.classList.toggle('hidden', !on);
  me.textContent = on ? user.email : 'Not signed in';
  signout.classList.toggle('hidden', !on);
  msg.textContent = (on && !IS_ADMIN) ? 'View-only (not an admin)' : '';
}
auth.onAuthStateChanged(u => setUI(u));

login.onclick = async () => {
  msg.textContent = 'Signing in...';
  try { await auth.signInWithEmailAndPassword(email.value.trim(), pass.value); msg.textContent = 'Signed in.'; }
  catch (e) { msg.textContent = e.message; }
};
create.onclick = async () => {
  if (!computeIsAdmin(auth.currentUser)) { msg.textContent = 'Only admins can create users here.'; return; }
  msg.textContent = 'Creating user...';
  try { await auth.createUserWithEmailAndPassword(email.value.trim(), pass.value); msg.textContent = 'User created.'; }
  catch (e) { msg.textContent = e.message; }
};
signout.onclick = () => auth.signOut();

// ---- Load stations from Firestore settings (dynamic) ----
async function loadStations(){
  try{
    const d = await db.collection('settings').doc('config').get();
    const conf = d.data();
    if (conf && Array.isArray(conf.stations) && conf.stations.length){
      STATIONS_ALL = conf.stations;
    }
  }catch(e){ /* keep fallback */ }
  // Populate the Add form select
  stationEl.innerHTML = STATIONS_ALL.map(s=>`<option>${s}</option>`).join('');
}
loadStations();

// ---- Live list, alphabetically by name ----
function loadMenu(){
  db.collection('menu').orderBy('name').onSnapshot(snap => {
    ALL = [];
    snap.forEach(d => ALL.push({ id: d.id, ...d.data() }));
    applyFilter();
  });
}
function applyFilter(){
  const q = (search.value || '').toLowerCase().trim();
  VIEW = ALL.filter(m => {
    const s = `${m.name||''} ${m.station||''}`.toLowerCase();
    return !q || s.includes(q);
  });
  renderTable();
}
search.oninput = applyFilter;

// ---- Render table (inline edit; no popups) ----
function trDisplay(m){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${m.img ? `<img class="thumb" src="${m.img}" alt="">` : `<div class="thumb"></div>`}</td>
    <td>${m.name || ''}</td>
    <td>$${Number(m.price || 0).toFixed(2)}</td>
    <td>${m.station || ''}</td>
    <td class="center">${m.active !== false ? 'Yes' : 'No'}</td>
    <td class="right">
      <button class="btn gray" data-edit="${m.id}">Edit</button>
      <button class="btn danger" data-del="${m.id}">Delete</button>
    </td>
  `;
  tr.querySelector('[data-edit]').onclick = () => switchToEdit(tr, m);
  tr.querySelector('[data-del]').onclick = () => delItem(m.id);
  return tr;
}
function esc(v){ return String(v??'').replace(/"/g,'&quot;'); }
function trEdit(m){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>
      <img class="thumb" src="${m.img ? esc(m.img) : ''}" alt="" onerror="this.src='';">
    </td>
    <td><input style="width:100%" data-k="name" value="${esc(m.name||'')}"></td>
    <td><input class="w120" type="number" step="0.01" data-k="price" value="${Number(m.price||0)}"></td>
    <td>
      <select class="w160" data-k="station">
        ${STATIONS_ALL.map(s => `<option ${s===(m.station||'')?'selected':''}>${s}</option>`).join('')}
      </select>
    </td>
    <td class="center"><input type="checkbox" data-k="active" ${m.active!==false?'checked':''}></td>
    <td class="right">
      <input class="w220" placeholder="Image URL" data-k="img" value="${esc(m.img||'')}" style="margin-right:8px">
      <button class="btn ok" data-save="${m.id}">Save</button>
      <button class="btn gray" data-cancel>Cancel</button>
    </td>
  `;
  // live preview for image
  const imgInput = tr.querySelector('[data-k="img"]');
  imgInput.oninput = () => { tr.querySelector('img.thumb').src = imgInput.value.trim(); };

  tr.querySelector('[data-save]').onclick = async () => {
    if (!IS_ADMIN) { alert('Not an admin.'); return; }
    const get = k => tr.querySelector(`[data-k="${k}"]`);
    const payload = {
      name: get('name').value.trim(),
      price: parseFloat(get('price').value),
      station: get('station').value,
      active: tr.querySelector('[data-k="active"]').checked,
      img: (get('img').value || '').trim() || null
    };
    if (!payload.name || !(payload.price>=0)) { alert('Name & valid price required.'); return; }
    try { await db.collection('menu').doc(m.id).update(payload); }
    catch(e){ alert(e.message); }
  };
  tr.querySelector('[data-cancel]').onclick = () => {
    const d = trDisplay(m);
    tr.replaceWith(d);
  };
  return tr;
}
function switchToEdit(tr, m){
  const editor = trEdit(m);
  tr.replaceWith(editor);
}
function renderTable(){
  tableBody.innerHTML = '';
  VIEW.forEach(m => tableBody.appendChild(trDisplay(m)));
  empty.style.display = VIEW.length ? 'none' : 'block';
}

// ---- Add item ----
addBtn.onclick = async () => {
  if (!IS_ADMIN) { alert('Not an admin.'); return; }
  const m = {
    name: (nameEl.value || '').trim(),
    price: parseFloat(priceEl.value),
    station: stationEl.value,
    active: !!activeEl.checked,
    img: (imgEl.value || '').trim() || null
  };
  if (!m.name || !(m.price >= 0)) { alert('Fill name & price.'); return; }
  try {
    await db.collection('menu').add(m);
    nameEl.value = ''; priceEl.value = ''; imgEl.value = '';
  } catch (e) {
    alert(e.message);
  }
};

// ---- Delete item ----
async function delItem(id){
  if (!IS_ADMIN) { alert('Not an admin.'); return; }
  if (!confirm('Delete this item?')) return;
  try { await db.collection('menu').doc(id).delete(); }
  catch (e) { alert(e.message); }
}

// start
loadMenu();
</script>
</body>
</html>
