<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pickup Display (v2)</title>

  <style>
    :root{--bg:#0d0f13;--fg:#f5f7fa;--muted:#95a0ad;--accent:#5b9bff;--ok:#2fd28f;--warn:#ffb020;--danger:#ff6b6b;--card:#0f141e;--border:#1b2230}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .space{height:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    .btn{border:none;border-radius:12px;padding:12px 14px;color:#fff;background:var(--accent);font:inherit;cursor:pointer}
    .btn.ok{background:var(--ok)} .btn.warn{background:var(--warn)} .btn.danger{background:var(--danger)} .btn.gray{background:#1e2432;color:#e5e8ee}
    input,select{font:inherit;background:#121826;color:#eaf0f6;border:1px solid var(--border);border-radius:12px;padding:12px 14px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0f1420;color:#95a0ad;font-size:12px}
    .grid{display:grid;gap:12px}
    .title{margin:0;font-size:20px}
    .small{font-size:12px;color:#95a0ad}
    .hidden{display:none!important}
    table{width:100%;border-collapse:collapse}
    td,th{border-bottom:1px solid var(--border);padding:8px;text-align:left}
  </style>

<style>
  .wrap{height:100vh;display:flex;flex-direction:column}
  .top{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
  .grid{flex:1;display:grid;gap:16px;padding:16px;overflow:auto}
  .tile{background:#121826;border:1px solid var(--border);border-radius:18px;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;min-height:160px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:10px}
  .num{font-size:54px;font-weight:800;letter-spacing:1px;line-height:1}
  .cust{margin-top:6px;font-size:18px;color:#e5e8ee}
  .meta{position:absolute;bottom:8px;right:10px;font-size:11px;color:#95a0ad}
  .foot{padding:10px 16px;border-top:1px solid var(--border);display:flex;justify-content:space-between;font-size:12px;color:#95a0ad}
</style>
</head>
<body>
<div id="app"></div>


  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>

<script>

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBu-Ux4lvGn6-pnBngmJzL0BAtW1uIfOKM",
  authDomain: "churchfestivalpos.firebaseapp.com",
  projectId: "churchfestivalpos",
  storageBucket: "churchfestivalpos.firebasestorage.app",
  messagingSenderId: "447909610900",
  appId: "1:447909610900:web:a54a828bacfa02e7883b81"
};

const qs=new URLSearchParams(location.search);
const cols=Math.max(1, parseInt(qs.get('cols')||'4',10));
const title=qs.get('title')||'Order Pickup';

function chime(){
  try{const ctx=new (window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator();const g=ctx.createGain();
    o.type='sine';o.frequency.value=880;o.connect(g);g.connect(ctx.destination);
    g.gain.value=0.0001;g.gain.exponentialRampToValueAtTime(0.25, ctx.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.35);o.start();o.stop(ctx.currentTime+0.4);}
  catch(e){}
}
function fmtAgo(ts){ if(!ts) return '—'; const d=Date.now()-ts; const m=Math.floor(d/60000); if(m<1) return 'now'; return m+'m'; }

firebase.initializeApp(FIREBASE_CONFIG);
const db=firebase.firestore();

const app=document.getElementById('app');
app.innerHTML = `
  <div class="wrap">
    <div class="top">
      <h2 class="title">${title}</h2>
      <span class="pill" id="count">Ready: 0</span>
    </div>
    <div class="grid" id="grid"></div>
    <div class="foot"><span>Watch for your name/number.</span><span id="time">—</span></div>
  </div>`;
const grid=document.getElementById('grid'); const count=document.getElementById('count'); const timeEl=document.getElementById('time');
grid.style.gridTemplateColumns=`repeat(${cols},1fr)`;

let newest=0, first=true;
db.collection('orders').where('status','==','ready').orderBy('readyAt','desc').limit(200).onSnapshot(s=>{
  const arr=[]; s.forEach(d=>arr.push({id:d.id,...d.data()}));
  grid.innerHTML = arr.map(o=>`
    <div class="tile">
      <div class="num">#${o.number}</div>
      <div class="cust">${o.customer?o.customer:''}</div>
      <div class="meta">${fmtAgo(o.readyAt)}</div>
    </div>`).join('');
  count.textContent='Ready: '+arr.length;
  timeEl.textContent='Last sync: '+new Date().toLocaleTimeString();
  const latest = arr.reduce((m,o)=>Math.max(m,o.readyAt||0),0);
  if(!first && latest>newest) chime();
  newest=Math.max(newest, latest); first=false;
});
</script>
</body></html>
